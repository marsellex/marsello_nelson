<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth + Leader Card (Supabase)</title>
  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b1020;
      --panel: rgba(14,18,28,.78);
      --line: rgba(255,255,255,.10);
      --text: rgba(232,238,250,.92);
      --muted: rgba(232,238,250,.55);
      --accent: 120 180 255;
      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background:
        radial-gradient(1100px 740px at 28% 18%, rgba(70, 120, 190, .22), transparent 60%),
        radial-gradient(880px 660px at 78% 75%, rgba(160, 70, 120, .18), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .card{
      width: min(560px, 100%);
      border-radius: var(--r1);
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(12px);
      padding: 14px;
    }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .title{
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
      white-space: pre-wrap;
    }
    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.86);
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(var(--accent), .35);
      background: rgba(255,255,255,.07);
    }
    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }

    .btn{
      border-radius: 14px;
      border: 1px solid rgba(var(--accent), .35);
      background: rgba(var(--accent), .10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btnDanger{
      border-radius: 14px;
      border: 1px solid rgba(255,140,120,.35);
      background: rgba(255,140,120,.10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }

    .profile{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .avatar{
      width: 64px; height: 64px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      flex:none;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; }
    .plogin{ font-weight: 900; font-size: 14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pnick{ margin-top: 6px; font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .hint{ font-size: 12px; color: var(--muted); }
    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; border-radius: 99px; }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">AUTH / LEADER CARD</div>
    <div class="sub" id="msg"></div>

    <div class="tabs" id="tabs">
      <button class="tab active" id="tLogin" type="button">Вход</button>
      <button class="tab" id="tReg" type="button">Регистрация</button>
    </div>

    <!-- LOGIN -->
    <div class="form" id="loginForm">
      <input class="field" id="emailL" placeholder="Email" autocomplete="email" />
      <input class="field" id="passL" placeholder="Пароль" type="password" autocomplete="current-password" />
      <button class="btn" id="loginBtn" type="button">Войти</button>
    </div>

    <!-- REGISTER -->
    <div class="form" id="regForm" style="display:none;">
      <div class="row">
        <input class="field" id="emailR" placeholder="Email" autocomplete="email" />
        <input class="field" id="passR" placeholder="Пароль" type="password" autocomplete="new-password" />
      </div>
      <button class="btn" id="regBtn" type="button">Создать аккаунт</button>
      <div class="hint">Если включено подтверждение email в Supabase — нужно подтвердить почту и затем войти.</div>
    </div>

    <!-- AUTHED AREA -->
    <div id="authedArea" style="display:none;">
      <div class="profile">
        <div class="avatar">
          <img id="avatarImg" alt="avatar"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E">
        </div>
        <div class="pmeta">
          <div class="plogin" id="pNick">—</div>
          <div class="pnick" id="pDept">—</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- LEADER EDITOR -->
      <div class="form">
        <div class="row">
          <input class="field" id="nickI" placeholder="Ник (nick)" />
          <input class="field" id="deptI" placeholder="Департамент (department)" />
        </div>

        <div class="row">
          <input class="field" id="accI" placeholder="Номер аккаунта (account_id)" />
          <input class="field" id="pointsI" placeholder="Текущее количество АШ (points)" inputmode="numeric" />
        </div>

        <div class="fileRow">
          <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          <button class="btn2" id="pickAvatar" type="button">Аватар</button>
          <div class="fileName" id="avatarName">—</div>
        </div>

        <button class="btn" id="saveLeaderBtn" type="button">Сохранить карточку лидера</button>
        <button class="btnDanger" id="logoutBtn" type="button">Выйти</button>

        <div class="hint">
          Сохраняется в таблицу <b>vk_leadboard</b>: department, nick, account_id, avatar_url, points.
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== твоё ======
    const SUPABASE_URL = "https://buwzzxpzcwjihvylfzom.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1d3p6eHB6Y3dqaWh2eWxmem9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDUwMTIsImV4cCI6MjA4MTkyMTAxMn0.5vYMVieAY_AAKdCw6_Y-aR21UJrl0A-AE-ayWPw-L54";

    // ====== elements ======
    const msg = document.getElementById("msg");

    const tLogin = document.getElementById("tLogin");
    const tReg = document.getElementById("tReg");
    const tabs = document.getElementById("tabs");

    const loginForm = document.getElementById("loginForm");
    const regForm = document.getElementById("regForm");
    const authedArea = document.getElementById("authedArea");

    const emailL = document.getElementById("emailL");
    const passL = document.getElementById("passL");
    const loginBtn = document.getElementById("loginBtn");

    const emailR = document.getElementById("emailR");
    const passR = document.getElementById("passR");
    const regBtn = document.getElementById("regBtn");

    const pNick = document.getElementById("pNick");
    const pDept = document.getElementById("pDept");
    const avatarImg = document.getElementById("avatarImg");

    const nickI = document.getElementById("nickI");
    const deptI = document.getElementById("deptI");
    const accI = document.getElementById("accI");
    const pointsI = document.getElementById("pointsI");

    const avatarFile = document.getElementById("avatarFile");
    const pickAvatar = document.getElementById("pickAvatar");
    const avatarName = document.getElementById("avatarName");

    const saveLeaderBtn = document.getElementById("saveLeaderBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setMsg(text){ msg.textContent = text || ""; }

    // ====== supabase init ======
    let supabase = null;
    try{
      if (!window.supabase?.createClient) throw new Error("Supabase SDK не загрузился (CDN).");
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }catch(e){
      console.error(e);
      setMsg(e.message);
    }

    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active");
        tReg.classList.remove("active");
        loginForm.style.display = "flex";
        regForm.style.display = "none";
      } else {
        tReg.classList.add("active");
        tLogin.classList.remove("active");
        loginForm.style.display = "none";
        regForm.style.display = "flex";
      }
    }

    function setAuthedUI(leader){
      tabs.style.display = "none";
      loginForm.style.display = "none";
      regForm.style.display = "none";
      authedArea.style.display = "block";

      // header
      pNick.textContent = leader?.nick || "—";
      pDept.textContent = leader?.department || "—";
      if (leader?.avatar_url) avatarImg.src = leader.avatar_url;

      // editor
      nickI.value = leader?.nick || "";
      deptI.value = leader?.department || "";
      accI.value = leader?.account_id || "";
      pointsI.value = (leader?.points ?? "").toString();
    }

    function setGuestUI(){
      authedArea.style.display = "none";
      tabs.style.display = "flex";
      showTab("login");
      setMsg("");
    }

    tLogin.addEventListener("click", () => showTab("login"));
    tReg.addEventListener("click", () => showTab("reg"));

    pickAvatar.addEventListener("click", () => avatarFile.click());
    avatarFile.addEventListener("change", () => {
      const f = avatarFile.files?.[0];
      avatarName.textContent = f ? f.name : "—";
    });

    // ====== helpers ======
    async function uploadAvatar(ownerId, file){
      // ownerId — строка (мы используем auth.uid() как текст)
      const ext = (file.name.split(".").pop() || "png").toLowerCase();
      const path = `${ownerId}/${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("avatars")
        .upload(path, file, { upsert: true, contentType: file.type });

      if (upErr) throw upErr;

      const { data } = supabase.storage.from("avatars").getPublicUrl(path);
      return data.publicUrl;
    }

    async function loadLeaderByAccountId(accountId){
      const { data, error } = await supabase
        .from("vk_leadboard")
        .select("id,nick,points,updated_at,avatar_url,account_id,department")
        .eq("account_id", accountId)
        .maybeSingle();

      if (error) throw error;
      return data || null;
    }

    async function upsertLeader(payload){
      // Требует уникальности account_id (см. настройки Supabase ниже)
      const { data, error } = await supabase
        .from("vk_leadboard")
        .upsert(payload, { onConflict: "account_id" })
        .select("id,nick,points,updated_at,avatar_url,account_id,department")
        .single();

      if (error) throw error;
      return data;
    }

    // ====== auth actions ======
    loginBtn.addEventListener("click", async () => {
      if (!supabase) return;
      setMsg("");

      const email = emailL.value.trim();
      const pass = passL.value;

      if (!email || !pass){
        setMsg("Заполни email и пароль");
        return;
      }

      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error){ setMsg(error.message); return; }

      const user = data.user;
      const accountId = String(user.id);

      try{
        // подставим account_id = uid по умолчанию (чтобы RLS работал)
        accI.value = accountId;

        let leader = await loadLeaderByAccountId(accountId);
        if (!leader){
          // если записи ещё нет — создадим пустую (можешь убрать автосоздание, если не нужно)
          leader = await upsertLeader({
            account_id: accountId,
            nick: "",
            department: "",
            points: 0,
            avatar_url: null
          });
        }
        setAuthedUI(leader);
      }catch(e){
        console.error(e);
        setMsg(e.message || "Ошибка загрузки лидера");
      }
    });

    regBtn.addEventListener("click", async () => {
      if (!supabase) return;
      setMsg("");

      const email = emailR.value.trim();
      const pass = passR.value;

      if (!email || !pass){
        setMsg("Заполни email и пароль");
        return;
      }

      const { data, error } = await supabase.auth.signUp({ email, password: pass });
      if (error){ setMsg(error.message); return; }

      // Если включено подтверждение email — user может быть null
      if (!data.user){
        setMsg("Аккаунт создан. Подтверди email и затем войди.");
        return;
      }

      setMsg("Аккаунт создан. Теперь войди.");
      showTab("login");
    });

    logoutBtn.addEventListener("click", async () => {
      if (!supabase) return;
      await supabase.auth.signOut();
      setGuestUI();
    });

    // ====== save leader card ======
    saveLeaderBtn.addEventListener("click", async () => {
      if (!supabase) return;
      setMsg("");

      const { data: sess } = await supabase.auth.getSession();
      const user = sess?.session?.user;
      if (!user){
        setMsg("Нет сессии. Войди заново.");
        setGuestUI();
        return;
      }

      const accountId = String(user.id); // ключ для RLS и onConflict
      const nick = (nickI.value || "").trim();
      const department = (deptI.value || "").trim();
      const pointsRaw = (pointsI.value || "").trim();
      const points = pointsRaw === "" ? 0 : Number(pointsRaw);

      if (!Number.isFinite(points) || points < 0){
        setMsg("points (АШ) должно быть числом >= 0");
        return;
      }

      // account_id в UI показываем, но сохраняем безопасно как uid (чтобы никто не мог писать чужое)
      accI.value = accountId;

      const file = avatarFile.files?.[0] || null;
      let avatarUrl = null;

      try{
        // сохраним текущий url, если не меняли файл
        const current = await loadLeaderByAccountId(accountId);
        avatarUrl = current?.avatar_url || null;

        if (file){
          avatarUrl = await uploadAvatar(accountId, file);
        }

        const saved = await upsertLeader({
          account_id: accountId,
          nick,
          department,
          points,
          avatar_url: avatarUrl
          // updated_at лучше делать триггером в БД (см. ниже)
        });

        avatarName.textContent = file ? file.name : "—";
        setAuthedUI(saved);
        setMsg("Сохранено ✅");
      }catch(e){
        console.error(e);
        setMsg(e.message || "Ошибка сохранения");
      }
    });

    // ====== init ======
    (async function init(){
      if (!supabase) return;
      const { data } = await supabase.auth.getSession();
      const user = data?.session?.user || null;
      if (!user){
        setGuestUI();
        return;
      }

      try{
        const accountId = String(user.id);
        accI.value = accountId;

        let leader = await loadLeaderByAccountId(accountId);
        if (!leader){
          leader = await upsertLeader({
            account_id: accountId,
            nick: "",
            department: "",
            points: 0,
            avatar_url: null
          });
        }
        setAuthedUI(leader);
      }catch(e){
        console.error(e);
        setGuestUI();
      }
    })();
  </script>
</body>
</html>
