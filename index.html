<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VK Leadboard Editor (Supabase)</title>
  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b1020;
      --panel: rgba(14,18,28,.78);
      --line: rgba(255,255,255,.10);
      --text: rgba(232,238,250,.92);
      --muted: rgba(232,238,250,.55);
      --accent: 120 180 255;
      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background:
        radial-gradient(1100px 740px at 28% 18%, rgba(70, 120, 190, .22), transparent 60%),
        radial-gradient(880px 660px at 78% 75%, rgba(160, 70, 120, .18), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 16px;
    }
    .card{
      width: min(980px, 100%);
      border-radius: var(--r1);
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(12px);
      padding: 14px;
    }
    .title{
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-width:0;
    }

    .btn{
      border-radius: 14px;
      border: 1px solid rgba(var(--accent), .35);
      background: rgba(var(--accent), .10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btnDanger{
      border-radius: 14px;
      border: 1px solid rgba(255,140,120,.35);
      background: rgba(255,140,120,.10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 180px; }

    .field{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
    }
    th, td{
      text-align:left;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 13px;
      vertical-align: middle;
    }
    th{ font-size: 12px; color: rgba(255,255,255,.75); letter-spacing:.06em; }
    .muted{ color: var(--muted); font-size:12px; }

    .ava{
      width:42px; height:42px; border-radius:999px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
    }
    .ava img{ width:100%; height:100%; object-fit:cover; display:block; }

    .editorTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .fileRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 260px;}
    .hint{ font-size:12px; color: var(--muted); margin-top:8px; line-height:1.4; }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">VK LEADBOARD</div>
    <div class="sub" id="msg"></div>

    <div class="grid">
      <!-- LEFT: LIST -->
      <div class="panel">
        <div class="editorTop">
          <div style="font-weight:900;">Лидеры</div>
          <div class="row" style="margin:0;">
            <input class="field" id="search" placeholder="Поиск по нику / аккаунту / департаменту" />
          </div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <button class="btn2" id="refreshBtn">Обновить</button>
          <button class="btn" id="newBtn">+ Новый лидер</button>
        </div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Аватар</th>
                <th>Ник</th>
                <th>Департамент</th>
                <th>Аккаунт</th>
                <th>АШ</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="hint">Редактирование пишет данные в таблицу <b>public.vk_leadboard</b> (nick, department, account_id, avatar_url, points).</div>
      </div>

      <!-- RIGHT: EDITOR -->
      <div class="panel">
        <div class="editorTop">
          <div style="font-weight:900;">Карточка лидера</div>
          <button class="btnDanger" id="clearBtn">Сброс</button>
        </div>

        <div class="row">
          <input class="field" id="nick" placeholder="Ник" />
          <input class="field" id="department" placeholder="Департамент" />
        </div>

        <div class="row" style="margin-top:10px;">
          <input class="field" id="accountId" placeholder="Номер аккаунта (account_id)" />
          <input class="field" id="points" placeholder="Текущее количество АШ" type="number" min="0" step="1" />
        </div>

        <div class="fileRow" style="margin-top:10px;">
          <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          <button class="btn2" id="pickAvatar">Выбрать аватар</button>
          <div class="fileName" id="avatarName">—</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveBtn">Сохранить</button>
          <button class="btn2" id="deleteBtn">Удалить</button>
        </div>

        <div class="hint">
          <div class="muted">Важно:</div>
          <ul class="muted" style="margin:6px 0 0 16px; padding:0; line-height:1.45;">
            <li>Для корректного <b>upsert</b> заполняй <b>account_id</b> (и сделай unique index как в SQL выше).</li>
            <li>Аватар загружается в Storage bucket <b>avatars</b>, затем URL пишется в <b>avatar_url</b>.</li>
            <li>Если RLS включен и не настроен — записи будут падать с “permission denied”.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://buwzzxpzcwjihvylfzom.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // <- оставь свой ключ
    const TABLE = "vk_leadboard";
    const AVATAR_BUCKET = "avatars";

    // ====== UI ======
    const msg = document.getElementById("msg");
    const tbody = document.getElementById("tbody");
    const refreshBtn = document.getElementById("refreshBtn");
    const newBtn = document.getElementById("newBtn");
    const search = document.getElementById("search");

    const nick = document.getElementById("nick");
    const department = document.getElementById("department");
    const accountId = document.getElementById("accountId");
    const points = document.getElementById("points");

    const avatarFile = document.getElementById("avatarFile");
    const pickAvatar = document.getElementById("pickAvatar");
    const avatarName = document.getElementById("avatarName");

    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const clearBtn = document.getElementById("clearBtn");

    function setMsg(text){ msg.textContent = text || ""; }

    // ====== Supabase init ======
    let supabase = null;
    try{
      if (!window.supabase?.createClient) throw new Error("Supabase SDK не загрузился (CDN).");
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }catch(e){
      console.error(e);
      setMsg(e.message);
    }

    // ====== State ======
    let leaders = [];
    let currentRow = null; // selected row

    // ====== Helpers ======
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function filterLeaders(q){
      q = (q || "").trim().toLowerCase();
      if (!q) return leaders;
      return leaders.filter(r => {
        const a = (r.account_id || "").toLowerCase();
        const n = (r.nick || "").toLowerCase();
        const d = (r.department || "").toLowerCase();
        return a.includes(q) || n.includes(q) || d.includes(q);
      });
    }

    function render(){
      const rows = filterLeaders(search.value);
      tbody.innerHTML = rows.map(r => {
        const img = r.avatar_url
          ? `<div class="ava"><img src="${escapeHtml(r.avatar_url)}" alt=""></div>`
          : `<div class="ava"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E" alt=""></div>`;

        return `
          <tr>
            <td>${img}</td>
            <td><b>${escapeHtml(r.nick)}</b></td>
            <td>${escapeHtml(r.department || "—")}</td>
            <td class="muted">${escapeHtml(r.account_id || "—")}</td>
            <td><b>${Number(r.points ?? 0)}</b></td>
            <td><button class="btn2" data-edit="${r.id}">Редактировать</button></td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = Number(btn.getAttribute("data-edit"));
          const row = leaders.find(x => x.id === id);
          if (row) loadIntoEditor(row);
        });
      });
    }

    function resetEditor(){
      currentRow = null;
      nick.value = "";
      department.value = "";
      accountId.value = "";
      points.value = "";
      avatarFile.value = "";
      avatarName.textContent = "—";
      setMsg("");
    }

    function loadIntoEditor(row){
      currentRow = row;
      nick.value = row.nick || "";
      department.value = row.department || "";
      accountId.value = row.account_id || "";
      points.value = row.points ?? 0;
      avatarFile.value = "";
      avatarName.textContent = "—";
      setMsg(`Редактирование: ${row.nick} (id=${row.id})`);
    }

    async function uploadAvatar(file, accountIdValue){
      const ext = (file.name.split(".").pop() || "png").toLowerCase();
      const safeAccount = (accountIdValue || "no_account").replaceAll(/[^\w\-]/g, "_");
      const path = `leaders/${safeAccount}/${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from(AVATAR_BUCKET)
        .upload(path, file, { upsert: true, contentType: file.type });

      if (upErr) throw upErr;

      const { data } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
      return data.publicUrl;
    }

    // ====== Data ======
    async function fetchLeaders(){
      if (!supabase) return;
      setMsg("");
      const { data, error } = await supabase
        .from(TABLE)
        .select("id,nick,points,updated_at,avatar_url,account_id,department")
        .order("points", { ascending: false })
        .limit(500);

      if (error){
        setMsg(error.message);
        return;
      }
      leaders = data || [];
      render();
    }

    async function saveLeader(){
      if (!supabase) return;
      setMsg("");

      const n = nick.value.trim();
      const d = department.value.trim();
      const a = accountId.value.trim();
      const p = Number(points.value || 0);
      const file = avatarFile.files?.[0] || null;

      if (!n || !d || !a){
        setMsg("Заполни ник, департамент и номер аккаунта (account_id).");
        return;
      }
      if (!Number.isFinite(p) || p < 0){
        setMsg("АШ (points) должен быть числом >= 0.");
        return;
      }

      let avatarUrl = currentRow?.avatar_url || null;
      try{
        if (file){
          avatarUrl = await uploadAvatar(file, a);
        }
      }catch(e){
        console.error(e);
        setMsg("Аватар не загрузился: " + (e?.message || String(e)));
        // не прерываем сохранение данных
      }

      // Upsert по account_id (нужен unique index на account_id)
      const payload = {
        nick: n,
        department: d,
        account_id: a,
        points: p,
        avatar_url: avatarUrl
      };

      const { data, error } = await supabase
        .from(TABLE)
        .upsert(payload, { onConflict: "account_id" })
        .select()
        .maybeSingle();

      if (error){
        setMsg(error.message);
        return;
      }

      setMsg("Сохранено.");
      await fetchLeaders();

      // подхватим сохранённую строку как текущую
      if (data) loadIntoEditor(data);
    }

    async function deleteLeader(){
      if (!supabase) return;
      setMsg("");

      if (!currentRow?.id){
        setMsg("Сначала выбери лидера для удаления.");
        return;
      }

      const { error } = await supabase
        .from(TABLE)
        .delete()
        .eq("id", currentRow.id);

      if (error){
        setMsg(error.message);
        return;
      }

      setMsg("Удалено.");
      resetEditor();
      await fetchLeaders();
    }

    // ====== Events ======
    refreshBtn.addEventListener("click", fetchLeaders);
    newBtn.addEventListener("click", () => {
      resetEditor();
      setMsg("Новый лидер: заполни поля и нажми Сохранить.");
    });
    clearBtn.addEventListener("click", resetEditor);

    search.addEventListener("input", render);

    pickAvatar.addEventListener("click", () => avatarFile.click());
    avatarFile.addEventListener("change", () => {
      const f = avatarFile.files?.[0];
      avatarName.textContent = f ? f.name : "—";
    });

    saveBtn.addEventListener("click", saveLeader);
    deleteBtn.addEventListener("click", deleteLeader);

    // init
    (async function init(){
      if (!supabase) return;
      await fetchLeaders();
      resetEditor();
    })();
  </script>
</body>
</html>
