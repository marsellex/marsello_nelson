<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Register/Login (no email)</title>
  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b1020;
      --panel: rgba(14,18,28,.78);
      --line: rgba(255,255,255,.10);
      --text: rgba(232,238,250,.92);
      --muted: rgba(232,238,250,.55);
      --accent: 120 180 255;
      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background:
        radial-gradient(1100px 740px at 28% 18%, rgba(70, 120, 190, .22), transparent 60%),
        radial-gradient(880px 660px at 78% 75%, rgba(160, 70, 120, .18), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
    }
    .card{
      width: min(520px, 100%);
      border-radius: var(--r1);
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(12px);
      padding: 14px;
    }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .title{
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      white-space: pre-line;
    }
    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.86);
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(var(--accent), .35);
      background: rgba(255,255,255,.07);
    }
    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }
    .btn{
      border-radius: 14px;
      border: 1px solid rgba(var(--accent), .35);
      background: rgba(var(--accent), .10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btnDanger{
      border-radius: 14px;
      border: 1px solid rgba(255,140,120,.35);
      background: rgba(255,140,120,.10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.35; }
    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .profile{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .avatar{
      width: 64px; height: 64px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      flex:none;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; }
    .plogin{ font-weight: 900; font-size: 14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pnick{ margin-top: 6px; font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sep{ height:1px; background: rgba(255,255,255,.08); margin-top: 12px; }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">GAME AUTH</div>
    <div class="sub" id="msg"></div>

    <div class="tabs" id="tabs">
      <button class="tab active" id="tLogin" type="button">Вход</button>
      <button class="tab" id="tReg" type="button">Регистрация</button>
    </div>

    <!-- LOGIN -->
    <div class="form" id="loginForm">
      <input class="field" id="loginL" placeholder="Логин" autocomplete="username" />
      <input class="field" id="passL" placeholder="Пароль" type="password" autocomplete="current-password" />
      <button class="btn" id="loginBtn" type="button">Войти</button>
    </div>

    <!-- REGISTER -->
    <div class="form" id="regForm" style="display:none;">
      <div class="row">
        <input class="field" id="loginR" placeholder="Логин (лат/цифры/_)" autocomplete="username" />
        <input class="field" id="nickR" placeholder="Ник (можно русский)" />
      </div>
      <input class="field" id="passR" placeholder="Пароль (мин. 6)" type="password" autocomplete="new-password" />

      <div class="fileRow">
        <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
        <button class="btn2" id="pickAvatar" type="button">Аватар</button>
        <div class="fileName" id="avatarName">—</div>
      </div>

      <button class="btn" id="regBtn" type="button">Создать аккаунт</button>
      <div class="hint">
        Уникальность: логин и ник должны быть разные у всех.
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profileArea" style="display:none;">
      <div class="profile">
        <div class="avatar">
          <img id="avatarImg" alt="avatar"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E">
        </div>
        <div class="pmeta">
          <div class="plogin" id="pLogin">—</div>
          <div class="pnick" id="pNick">—</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="form">
        <button class="btnDanger" id="logoutBtn" type="button">Выйти</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    var SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    function $(id){ return document.getElementById(id); }
    var msg = $("msg");

    var tLogin = $("tLogin"), tReg = $("tReg");
    var tabsEl = $("tabs");
    var loginForm = $("loginForm"), regForm = $("regForm");
    var profileArea = $("profileArea");

    var loginL = $("loginL"), passL = $("passL"), loginBtn = $("loginBtn");
    var loginR = $("loginR"), nickR = $("nickR"), passR = $("passR"), regBtn = $("regBtn");

    var avatarFile = $("avatarFile"), pickAvatar = $("pickAvatar"), avatarName = $("avatarName");
    var pLogin = $("pLogin"), pNick = $("pNick"), avatarImg = $("avatarImg");
    var logoutBtn = $("logoutBtn");

    function setMsg(text){ msg.textContent = text || ""; }
    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active"); tReg.classList.remove("active");
        loginForm.style.display = "flex"; regForm.style.display = "none";
      } else {
        tReg.classList.add("active"); tLogin.classList.remove("active");
        loginForm.style.display = "none"; regForm.style.display = "flex";
      }
    }

    function setAuthedUI(user){
      profileArea.style.display = "block";
      tabsEl.style.display = "none";
      loginForm.style.display = "none";
      regForm.style.display = "none";

      pLogin.textContent = user.login;
      pNick.textContent = user.nick;
      if (user.avatar_url) avatarImg.src = user.avatar_url;
    }

    function setGuestUI(){
      profileArea.style.display = "none";
      tabsEl.style.display = "flex";
      showTab("login");
      setMsg("");
    }

    function validLogin(login){
      return /^[a-zA-Z0-9_]{3,20}$/.test(login);
    }

    if (!window.supabase || !window.supabase.createClient){
      setMsg("Supabase SDK не загрузился (CDN).");
      return;
    }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== AVATAR upload (bucket avatars должен быть public) ======
    async function uploadAvatar(file){
      var ext = (file.name.split(".").pop() || "png").toLowerCase();
      var path = "public/" + Date.now() + "_" + Math.random().toString(16).slice(2) + "." + ext;

      var up = await supabase.storage.from("avatars")
        .upload(path, file, { upsert: true, contentType: file.type });

      if (up.error) throw up.error;

      var pub = supabase.storage.from("avatars").getPublicUrl(path);
      return pub && pub.data ? pub.data.publicUrl : null;
    }

    // ====== Password hash (SHA-256) ======
    async function sha256(text){
      var enc = new TextEncoder().encode(text);
      var buf = await crypto.subtle.digest("SHA-256", enc);
      var arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function loginExists(login){
      var res = await supabase.from("game_users")
        .select("id")
        .ilike("login", login)  // case-insensitive (если postgrest настроено)
        .limit(1);
      // если ilike недоступен, можно заменить на eq(lower) через view/функцию, но обычно ilike работает
      if (res.error) throw res.error;
      return (res.data && res.data.length > 0);
    }

    async function nickExists(nick){
      var res = await supabase.from("game_users")
        .select("id")
        .ilike("nick", nick)
        .limit(1);
      if (res.error) throw res.error;
      return (res.data && res.data.length > 0);
    }

    async function getUserByLogin(login){
      var res = await supabase.from("game_users")
        .select("id,login,nick,pass_hash,avatar_url")
        .eq("login", login)
        .limit(1)
        .maybeSingle();
      if (res.error) throw res.error;
      return res.data || null;
    }

    function saveSession(user){
      // храним без пароля
      localStorage.setItem("game_user", JSON.stringify({
        id: user.id,
        login: user.login,
        nick: user.nick,
        avatar_url: user.avatar_url || null
      }));
    }

    function loadSession(){
      try{ return JSON.parse(localStorage.getItem("game_user") || "null"); }
      catch(e){ return null; }
    }

    function clearSession(){
      localStorage.removeItem("game_user");
    }

    // Tabs + avatar picker
    tLogin.onclick = function(){ showTab("login"); };
    tReg.onclick = function(){ showTab("reg"); };

    pickAvatar.onclick = function(){ avatarFile.click(); };
    avatarFile.onchange = function(){
      var f = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;
      avatarName.textContent = f ? f.name : "—";
    };

    // ====== REGISTER ======
    regBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginR.value || "").trim();
        var nick  = (nickR.value || "").trim();
        var pass  = passR.value || "";
        var file  = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;

        if (!login || !nick || !pass){ setMsg("Заполни поля"); return; }
        if (!validLogin(login)){ setMsg("Логин: 3–20 символов, только латиница/цифры/_"); return; }
        if (pass.length < 6){ setMsg("Пароль минимум 6 символов"); return; }

        // Проверки уникальности
        if (await loginExists(login)){ setMsg("Такой логин уже занят"); return; }
        if (await nickExists(nick)){ setMsg("Такой ник уже занят"); return; }

        var avatarUrl = null;
        if (file){
          try{ avatarUrl = await uploadAvatar(file); }
          catch(e){ console.error(e); }
        }

        var hash = await sha256(pass);

        var ins = await supabase.from("game_users").insert({
          login: login,
          nick: nick,
          pass_hash: hash,
          avatar_url: avatarUrl
        }).select("id,login,nick,avatar_url").single();

        if (ins.error){
          console.error(ins.error);
          setMsg(ins.error.message || "Ошибка регистрации");
          return;
        }

        saveSession(ins.data);
        setAuthedUI(ins.data);
        setMsg("");

      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    // ====== LOGIN ======
    loginBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginL.value || "").trim();
        var pass  = passL.value || "";
        if (!login || !pass){ setMsg("Введи логин и пароль"); return; }

        var user = await getUserByLogin(login);
        if (!user){ setMsg("Неверный логин или пароль"); return; }

        var hash = await sha256(pass);
        if (hash !== user.pass_hash){
          setMsg("Неверный логин или пароль");
          return;
        }

        // успешный вход
        saveSession(user);
        setAuthedUI(user);
        setMsg("");

      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    // ====== LOGOUT ======
    logoutBtn.onclick = function(){
      clearSession();
      setGuestUI();
    };

    // init session
    (function init(){
      var s = loadSession();
      if (s && s.login) setAuthedUI(s);
      else setGuestUI();
    })();

  })();
  </script>
</body>
</html>
