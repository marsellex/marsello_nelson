<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WORLD_SCRIPT</title>
  <link rel="icon" type="image/png" href="IconWorld.png">
  <link rel="apple-touch-icon" href="IconWorld.png">
  <meta name="theme-color" content="#0b0614">

  <style>
    :root{
      --bg0:#07040a;
      --bg1:#0b0614;

      --panel: rgba(12, 8, 14, .74);
      --text: rgba(255,245,240,.94);
      --muted: rgba(255,220,210,.62);

      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --parX: 0px;
      --parY: 0px;

      --accA: rgba(70,220,200,.85);
      --accB: rgba(180,120,255,.85);

      --danger: rgba(255, 100, 120, .95);
      --ok: rgba(120, 255, 190, .95);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* ======= ПРИЯТНЫЙ ГРАДИЕНТНЫЙ ФОН ======= */
    .bgRoot{
      position: fixed;
      inset: 0;
      z-index: -10;
      overflow: hidden;
      background: #07040a;
    }
    .bgLayer{
      position:absolute;
      inset:-15%;
      background:
        radial-gradient(900px 540px at 18% 18%, rgba(90,140,255,.16), transparent 60%),
        radial-gradient(820px 520px at 78% 30%, rgba(180,120,255,.12), transparent 62%),
        radial-gradient(900px 620px at 55% 90%, rgba(70,220,200,.10), transparent 62%),
        linear-gradient(180deg, #0a0615, #07040a);
      background-size: cover;
      background-position: center;
      filter: blur(18px) saturate(1.15) contrast(1.05);
      transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08);
      opacity: .85;
      will-change: transform;
      animation: slowPan 26s ease-in-out infinite;
    }
    @keyframes slowPan{
      0%   { background-position: 30% 35%; transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08); }
      50%  { background-position: 70% 55%; transform: translate(calc(var(--parX) * 0.05), calc(var(--parY) * 0.05)) scale(1.12); }
      100% { background-position: 30% 35%; transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08); }
    }
    .bgLayer.alt{
      opacity: .55;
      filter: blur(22px) saturate(1.20) contrast(1.06);
      animation-duration: 32s;
    }

    .bgTint{
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 25% 25%, rgba(120,160,255,.12), transparent 60%),
        radial-gradient(980px 620px at 75% 70%, rgba(190,120,255,.10), transparent 62%),
        radial-gradient(1100px 800px at 50% 120%, rgba(0,0,0,.62), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.58));
      pointer-events:none;
      z-index: 2;
    }

    .smoke{
      position:absolute;
      inset:-20%;
      pointer-events:none;
      z-index: 3;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(120,160,255,.08), transparent 60%),
        radial-gradient(820px 480px at 80% 30%, rgba(190,120,255,.07), transparent 58%),
        radial-gradient(780px 520px at 60% 80%, rgba(70,220,200,.06), transparent 60%),
        radial-gradient(680px 460px at 30% 70%, rgba(255,255,255,.03), transparent 62%);
      filter: blur(28px);
      opacity: .55;
      animation: smokeMove 18s ease-in-out infinite;
      transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12);
      will-change: transform;
    }
    @keyframes smokeMove{
      0%   { transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12) rotate(0deg); }
      50%  { transform: translate(calc(var(--parX) * 0.04), calc(var(--parY) * 0.04)) scale(1.18) rotate(1.2deg); }
      100% { transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12) rotate(0deg); }
    }

    /* ===== AUTH CARD ===== */
    .authWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .card{
      width: min(540px, 100%);
      border-radius: var(--r1);
      background: linear-gradient(180deg, rgba(18,10,18,.78), rgba(8,6,10,.64));
      border: 1px solid rgba(180, 120, 255, .30);
      backdrop-filter: blur(14px);
      padding: 14px;
      box-shadow:
        0 30px 90px rgba(0,0,0,.55),
        0 0 0 1px rgba(180,120,255,.10),
        0 0 40px rgba(180,120,255,.10);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 5%, rgba(120,160,255,.14), transparent 60%),
        radial-gradient(520px 240px at 90% 20%, rgba(190,120,255,.12), transparent 55%),
        radial-gradient(520px 260px at 48% 120%, rgba(70,220,200,.10), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .card > *{ position:relative; z-index:1; }

    .title{
      font-weight: 1000;
      letter-spacing: .14em;
      color: rgba(255,255,255,.86);
      font-size: 12px;
      text-transform: uppercase;
      filter: drop-shadow(0 0 12px rgba(180,120,255,.22));
    }

    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      white-space: pre-line;
    }

    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.88);
      font-weight: 950;
      font-size: 12px;
      user-select:none;
      transition: .14s transform, .14s box-shadow, .14s border-color;
      text-transform: uppercase;
      letter-spacing:.08em;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow: 0 0 18px rgba(180,120,255,.12); }
    .tab.active{
      border-color: rgba(180,120,255,.55);
      background: rgba(255,255,255,.07);
      box-shadow: 0 0 20px rgba(180,120,255,.14);
    }

    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }

    /* ===== Button states (loading/disabled) ===== */
    .btn, .btn2, .miniBtn, .sideBtn, .navBtn{
      -webkit-tap-highlight-color: transparent;
    }
    .btn{
      border-radius: 14px;
      border: 1px solid rgba(180, 120, 255, .60);
      background: linear-gradient(135deg, rgba(90,140,255,.18), rgba(180,120,255,.12));
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.94);
      transition: .14s transform, .14s box-shadow, .14s border-color, .14s opacity;
      text-transform: uppercase;
      letter-spacing: .08em;
      box-shadow:
        0 0 18px rgba(180,120,255,.14),
        0 20px 60px rgba(0,0,0,.35);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height: 42px;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow:
        0 0 26px rgba(180,120,255,.22),
        0 0 55px rgba(90,140,255,.14),
        0 26px 70px rgba(0,0,0,.45);
      border-color: rgba(70, 220, 200, .70);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      min-height: 42px;
    }
    .btn2:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.12); }
    .btn2:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .spinner{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      border-top-color: rgba(70,220,200,.90);
      animation: spin .7s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.35; }

    /* preview for reg avatar */
    .avatarPreview{
      margin-top: 8px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .avatarPreview .bubble{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 2px solid rgba(190,120,255,.75);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      box-shadow: 0 0 20px rgba(190,120,255,.14);
      flex:0 0 auto;
    }
    .avatarPreview img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatarPreview .txt{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    /* ===== GAME SHELL ===== */
    .shell{
      display:none;
      min-height:100vh;
      padding: 18px;
      position:relative;
    }

    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      align-items:start;
    }

    .panel{
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(18,10,18,.78), rgba(8,6,10,.64));
      border: 1px solid rgba(180, 120, 255, .28);
      backdrop-filter: blur(12px);
      box-shadow:
        0 26px 70px rgba(0,0,0,.45),
        0 0 0 1px rgba(180, 120, 255, .10),
        0 0 40px rgba(180, 120, 255, .10);
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(540px 260px at 12% 10%, rgba(90,140,255,.16), transparent 60%),
        radial-gradient(520px 260px at 92% 22%, rgba(190,120,255,.12), transparent 58%),
        radial-gradient(520px 260px at 48% 120%, rgba(70,220,200,.10), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .panel > *{ position:relative; z-index:1; }

    .sidebar{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 520px;
    }

    .profileBox{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }

    .ava{
      width:64px;height:64px;border-radius:999px;
      border: 2px solid rgba(190, 120, 255, .75);
      box-shadow: 0 0 26px rgba(190,120,255,.18);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      cursor:pointer;
      position:relative;
    }
    .ava:after{
      content:"Сменить";
      position:absolute;
      inset:auto 6px 6px 6px;
      font-size:10px;
      color: rgba(255,255,255,.82);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 2px 6px;
      text-align:center;
      opacity: 0;
      transform: translateY(4px);
      transition: .14s;
      pointer-events:none;
      backdrop-filter: blur(10px);
    }
    .ava:hover:after{ opacity:1; transform: translateY(0); }
    .ava img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pNick{ font-weight:1000; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pLogin{ margin-top:6px; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .sideGrid{
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: repeat(4, 1fr);
      gap: 10px;
    }

    .sideBtn{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s filter,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      padding: 12px;
      min-height: 46px;
    }
    .sideBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(180,120,255,.38);
      box-shadow: 0 0 18px rgba(180,120,255,.12);
    }
    .sideBtn.hot{
      border-color: rgba(70,220,200,.60);
      background: linear-gradient(135deg, rgba(70,220,200,.14), rgba(190,120,255,.10));
      box-shadow: 0 0 18px rgba(180,120,255,.10);
    }
    .sideBtn.hot:before{
      content:"";
      position:absolute;
      inset:-60px;
      background: radial-gradient(circle, rgba(70, 220, 200, .14), transparent 60%);
      animation: pulseGlow 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulseGlow{
      0%,100%{ opacity:.55; transform: translateX(-6px); }
      50%{ opacity:1; transform: translateX(6px); }
    }

    /* подсветка активного раздела */
    .sideBtn.active,
    .navBtn.active{
      border-color: rgba(70,220,200,.80);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(70,220,200,.14),
        0 0 50px rgba(90,140,255,.10);
      filter: saturate(1.05);
    }
    .sideBtn.active:after,
    .navBtn.active:after{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(70,220,200,.14), transparent 60%);
      opacity: .85;
      pointer-events:none;
      animation: activePulse 2.6s ease-in-out infinite;
    }
    @keyframes activePulse{
      0%,100%{ transform: translateX(-6px); opacity:.55; }
      50%{ transform: translateX(6px); opacity:1; }
    }

    .sideBtn:disabled,
    .navBtn:disabled,
    .miniBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
      filter:none !important;
    }

    .miniBtn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      min-height: 42px;
      position:relative;
      overflow:hidden;
    }
    .miniBtn:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.12); }

    /* ===== БАЛАНС: КРУГ + СИНЕЕ СВЕЧЕНИЕ ===== */
    .balanceBox{
      width: 138px;
      height: 138px;
      padding: 0;
      border-radius: 999px;

      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;

      margin: 6px auto 0;

      background: rgba(0,0,0,.18);

      border: 2px solid rgba(0, 170, 255, .70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 18px rgba(0,170,255,.30),
        0 0 44px rgba(0,170,255,.16),
        0 16px 40px rgba(0,0,0,.22);
    }
    .balanceTitle{ display:none !important; }
    .balanceValue{
      margin: 0;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.02em;
      color: rgba(243,246,255,.96);
      text-shadow:
        0 0 18px rgba(0,170,255,.20),
        0 0 10px rgba(0,0,0,.40);
      filter:none;
    }

    .main{ padding: 14px; min-height: 520px; }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .navRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    .navBtn{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      position:relative;
      overflow:hidden;
      min-height: 42px;
    }
    .navBtn:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.10); }

    .navBtn.market{
      border-color: rgba(70,220,200,.60);
      background: linear-gradient(135deg, rgba(70,220,200,.14), rgba(190,120,255,.10));
      box-shadow: 0 0 22px rgba(180,120,255,.10);
      position:relative;
      overflow:hidden;
    }
    .navBtn.market:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(70,220,200,.14), transparent 60%);
      animation: pulseGlow 2.2s ease-in-out infinite;
      pointer-events:none;
    }

    .onlinePill{
      border-radius: 999px;
      width: 58px;
      height: 58px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 3px solid rgba(70, 220, 200, .70);
      box-shadow:
        0 0 28px rgba(70,220,200,.18),
        0 0 60px rgba(180, 120, 255, .10);
      background: rgba(255,255,255,.03);
      font-weight:1000;
      font-size: 16px;
      position: fixed;
      right: 18px;
      top: 18px;
      z-index: 5;
      user-select:none;
      backdrop-filter: blur(10px);
    }

    /* ===== История ===== */
    .history{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(180, 120, 255, .50);
      background: rgba(255,255,255,.02);
      padding: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }

    .historyTitleBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;

      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .historyTitleBar .sub{
      margin:0;
      min-height:auto;
      font-size: 11px;
      color: rgba(255,255,255,.60);
      letter-spacing:.10em;
      white-space: nowrap;
    }

    .historyGrid{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .hRow{
      display:grid;
      grid-template-columns: 74px 1fr;
      gap: 12px;
      align-items: stretch;
      min-height: 64px;
    }

    .hLeft{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding-top: 2px;
    }

    .hDot{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 2px solid rgba(180, 120, 255, .70);
      box-shadow: 0 0 18px rgba(180,120,255,.12);
      background: rgba(0,0,0,.12);
      position: relative;
      overflow:hidden;
    }
    .hDot:after{
      content:"";
      position:absolute;
      inset:-10px;
      background: radial-gradient(circle at 30% 30%, rgba(70,220,200,.18), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .hDot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      position:relative;
      z-index:1;
    }

    .hLogin{
      font-size: 10px;
      color: rgba(255,255,255,.78);
      max-width: 70px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }

    .hItem{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height: 64px;
    }

    .hTop{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.15;
    }
    .hText{
      margin-top: 6px;
      font-weight: 1000;
      letter-spacing:.02em;
      line-height: 1.15;
    }

    /* profile view */
    .profileView{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(180,120,255,.55);
      background: rgba(255,255,255,.03);
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }
    .profileTitle{
      font-weight: 1000;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .profileText{
      margin-top: 10px;
      white-space: pre-line;
      line-height: 1.35;
      color: rgba(255,245,240,.92);
      font-size: 13px;
    }

    /* Change password block */
    .pwBox{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .pwTitle{
      font-size: 12px;
      color: rgba(255,255,255,.86);
      font-weight: 1000;
      letter-spacing:.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pwGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .pwRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,14,26,.78);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: .18s opacity, .18s transform;
      z-index: 50;
      user-select:none;
      max-width: calc(100vw - 24px);
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* ====== LOGO ORB: ПЕРЕНЕСЁН ВНИЗ СЛЕВА (фикс) ====== */
    .logoOrb{
      width: 74px;
      height: 74px;
      border-radius: 999px;
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 60;

      display:flex;
      align-items:center;
      justify-content:center;

      border: 2px solid rgba(180,120,255,.38);
      background: rgba(0,0,0,.18);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 22px rgba(90,140,255,.10),
        0 0 30px rgba(180,120,255,.10);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: .18s transform, .18s box-shadow, .18s border-color, .18s filter;
    }
    .logoOrb img{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      position:relative;
      z-index:2;
      filter: saturate(1.05);
    }
    .logoOrb:before,
    .logoOrb:after{
      content:"";
      position:absolute;
      inset:-40%;
      pointer-events:none;
      opacity: 0;
      transition: .18s opacity;
      z-index:1;
      filter: blur(14px);
    }
    .logoOrb:before{
      background:
        radial-gradient(circle at 35% 35%, rgba(80,180,255,.28), transparent 58%),
        radial-gradient(circle at 70% 60%, rgba(70,220,200,.18), transparent 62%),
        radial-gradient(circle at 40% 80%, rgba(120,160,255,.18), transparent 60%);
    }
    .logoOrb:after{
      background:
        radial-gradient(circle at 30% 70%, rgba(80,180,255,.22), transparent 62%),
        radial-gradient(circle at 70% 30%, rgba(120,160,255,.20), transparent 60%),
        radial-gradient(circle at 50% 50%, rgba(70,220,200,.16), transparent 60%);
      mix-blend-mode: screen;
    }
    @keyframes logoSmoke{
      0%   { transform: translate(-2%, 2%) rotate(0deg) scale(1.05); }
      50%  { transform: translate(3%, -3%) rotate(1.2deg) scale(1.12); }
      100% { transform: translate(-2%, 2%) rotate(0deg) scale(1.05); }
    }
    .logoOrb:hover{
      border-color: rgba(70,220,200,.70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.08) inset,
        0 0 28px rgba(80,180,255,.20),
        0 0 46px rgba(70,220,200,.14),
        0 26px 70px rgba(0,0,0,.38);
      filter: saturate(1.10) brightness(1.05);
      transform: translateY(-1px);
    }
    .logoOrb:hover:before,
    .logoOrb:hover:after{
      opacity: 1;
      animation: logoSmoke 2.8s ease-in-out infinite;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .sideGrid{ grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
      .pwRow{ grid-template-columns: 1fr; }
    }

    /* ===== profileBox clickable ===== */
    .profileClickable{
      cursor: pointer;
      transition: .14s transform, .14s box-shadow, .14s border-color;
    }
    .profileClickable:hover{
      transform: translateY(-1px);
      border-color: rgba(70,220,200,.35);
      box-shadow: 0 0 18px rgba(70,220,200,.10);
    }
    .profileClickable:active{ transform: translateY(0); }
    
    /* ===== Modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 120;
    }
    .modal.active{ display:flex; }
    
    .modalCard{
      width: min(520px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(18,10,18,.88), rgba(8,6,10,.76));
      border: 1px solid rgba(180,120,255,.30);
      box-shadow:
        0 30px 90px rgba(0,0,0,.55),
        0 0 40px rgba(180,120,255,.10);
      overflow:hidden;
      position:relative;
    }
    .modalCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 5%, rgba(120,160,255,.14), transparent 60%),
        radial-gradient(520px 240px at 90% 20%, rgba(190,120,255,.12), transparent 55%),
        radial-gradient(520px 260px at 48% 120%, rgba(70,220,200,.10), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .modalCard > *{ position:relative; z-index:1; }
    
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px;
    }
    .modalTitle{
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.88);
    }
    .modalClose{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.90);
      cursor:pointer;
    }
    .modalClose:hover{
      border-color: rgba(180,120,255,.35);
      box-shadow: 0 0 18px rgba(180,120,255,.10);
    }
    
    .modalBody{ padding: 0 14px 14px; }
    
    .pRow{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      margin-top: 10px;
    }
    .pLabel{
      color: rgba(255,255,255,.62);
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-weight: 900;
    }
    .pValue{
      font-weight: 1000;
      color: rgba(255,255,255,.92);
      min-width: 0;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    
    .passLine{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn2.tiny{
      min-height: 34px;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    /* ===== MARKET MENU ===== */
    .dimmed{
      opacity: .35 !important;
      filter: grayscale(.2) saturate(.75) brightness(.9);
    }
    
    .marketBox{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(70,220,200,.55);
      background: rgba(255,255,255,.02);
      padding: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }
    
    .marketTitleBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    
    .marketGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .marketPanel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      min-height: 360px;
      display:flex;
      flex-direction:column;
    }
    
    .marketPanelTitle{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.80);
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    
    .marketList{
      overflow:auto;
      max-height: 420px;
      padding-right: 6px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    
    .mItem{
      display:grid;
      grid-template-columns: 54px 1fr auto;
      gap: 10px;
      align-items:center;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 10px;
    }
    
    .mImg{
      width:54px; height:54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.20);
      box-shadow: 0 0 18px rgba(180,120,255,.10);
    }
    .mImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    
    .mName{
      font-weight: 1000;
      line-height: 1.15;
    }
    .mSub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.62);
      line-height: 1.15;
    }
    
    .mPrice{
      font-weight: 1000;
      color: rgba(243,246,255,.95);
      white-space:nowrap;
      text-shadow: 0 0 12px rgba(70,220,200,.12);
    }
    
    @media (max-width: 980px){
      .marketGrid{ grid-template-columns: 1fr; }
    }
    
    .navBtn.admin{
      border-color: rgba(255, 210, 120, .75);
      background: linear-gradient(135deg, rgba(255,210,120,.16), rgba(180,120,255,.10));
      box-shadow:
        0 0 22px rgba(255,210,120,.18),
        0 0 55px rgba(255,210,120,.08);
      position:relative;
      overflow:hidden;
    }
    .navBtn.admin:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(255,210,120,.18), transparent 60%);
      animation: pulseGlow 2.0s ease-in-out infinite;
      pointer-events:none;
    }

    .logoutBtn{
      position: fixed;
      left: 18px;
      bottom: 102px; /* над логотипом (logoOrb 74px + отступы) */
      z-index: 60;
    
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
    
      padding: 10px 12px;
      min-height: 44px;
      cursor: pointer;
    
      font-weight: 1000;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
    
      backdrop-filter: blur(12px);
      box-shadow:
        0 18px 50px rgba(0,0,0,.32),
        0 0 20px rgba(180,120,255,.10);
    
      transition: .14s transform, .14s box-shadow, .14s border-color, .14s opacity;
    }
    .logoutBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255, 100, 120, .55);
      box-shadow:
        0 0 22px rgba(255,100,120,.12),
        0 18px 60px rgba(0,0,0,.38);
    }
    .logoutBtn:active{ transform: translateY(0); }
    .logoutBtn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }
    

    
  </style>
</head>

<body>
  <div class="bgRoot" id="bgRoot">
    <div class="bgLayer" id="bgA"></div>
    <div class="bgLayer alt" id="bgB"></div>
    <div class="smoke"></div>
    <div class="bgTint"></div>
  </div>

  <div class="onlinePill" title="Онлайн" id="onlinePill">—</div>

  <!-- AUTH -->
  <div class="authWrap" id="authWrap">
    <div class="card">
      <div class="title">GAME AUTH</div>
      <div class="sub" id="msg"></div>

      <div class="tabs" id="tabs">
        <button class="tab active" id="tLogin" type="button">Вход</button>
        <button class="tab" id="tReg" type="button">Регистрация</button>
      </div>

      <div class="form" id="loginForm">
        <input class="field" id="loginL" placeholder="Логин" autocomplete="username" />
        <input class="field" id="passL" placeholder="Пароль" type="password" autocomplete="current-password" />
        <button class="btn" id="loginBtn" type="button">Войти</button>
      </div>

      <div class="form" id="regForm" style="display:none;">
        <div class="row">
          <input class="field" id="loginR" placeholder="Логин (лат/цифры/_)" autocomplete="username" />
          <input class="field" id="nickR" placeholder="Ник (можно русский)" />
        </div>
        <input class="field" id="passR" placeholder="Пароль (мин. 6)" type="password" autocomplete="new-password" />

        <div class="fileRow">
          <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          <button class="btn2" id="pickAvatar" type="button">Аватар</button>
          <div class="fileName" id="avatarName">—</div>
        </div>

        <div class="avatarPreview">
          <div class="bubble">
            <img id="avatarPreviewImg" alt="avatar preview"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.55' font-family='Arial'%3E%2B%3C/text%3E%3C/svg%3E" />
          </div>
          <div class="txt" id="avatarPreviewTxt">Выбери изображение — мы его сожмём до небольшого размера</div>
        </div>

        <button class="btn" id="regBtn" type="button">Создать аккаунт</button>
        <div class="hint">Логин и ник должны быть уникальны.</div>
      </div>
    </div>
  </div>

  <!-- SHELL -->
  <div class="shell" id="shell">
    <div class="layout">
      <div class="panel">
        <div class="sidebar">

          <div class="profileBox profileClickable" id="profileBox" role="button" tabindex="0" title="Открыть профиль">
            <div class="ava" id="shellAvaBox" title="Нажми чтобы сменить аватар">
              <img id="shellAvatar" alt="avatar"
                   src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E" />
            </div>
            <div>
              <div class="pNick" id="shellNick">—</div>
              <div class="pLogin" id="shellLogin">—</div>
            </div>
          </div>

          <input id="avatarChangeFile" type="file" accept="image/*" style="display:none;" />

          <div class="sideGrid">
            <button class="sideBtn hot" id="btnBonus" type="button">Бонус</button>
            <button class="sideBtn" id="btnRoulette" type="button">Рулетка</button>
            <button class="sideBtn" id="btnChance" type="button">Шанс</button>
          </div>


          <!-- Баланс: круг -->
          <div class="balanceBox">
            <div class="balanceValue" id="balanceValue">$0</div>
          </div>

          <div class="hint" style="padding:0 6px;">
            История справа: Сверху свежее, снизу старое
          </div>

        </div>
      </div>

      <div class="panel">
        <div class="main">
          <div class="topRow">
            <div class="navRow">
              <!-- Главная удалена -->
              <button class="navBtn market" id="btnMarket" type="button">Рынок предметов</button>
              <button class="navBtn" id="btnMyItems" type="button">Мои предметы</button>
              <button class="navBtn" id="btnGames" type="button">Игры</button>
              <button class="navBtn admin" id="btnAdmin" type="button" style="display:none;">Админка</button>
            </div>
          </div>

          <!-- HISTORY (сразу сверху) -->
          <div id="viewHistory">
            <div class="history">
              <div class="historyTitleBar">
                <span>История действий пользователей</span>
                <span class="sub">до 10 действий</span>
              </div>
              <div class="historyGrid" id="historyGrid"></div>
            </div>
          </div>

          <!-- MARKET MENU -->
          <div id="viewMarket" style="display:none;">
            <div class="marketBox">
              <div class="marketTitleBar">
                <span>Рынок предметов</span>
                <button class="btn2 tiny" id="exitMenuBtn" type="button">Выйти из меню</button>
              </div>
          
              <div class="marketGrid">
                <!-- LEFT: user items -->
                <div class="marketPanel">
                  <div class="marketPanelTitle">
                    <span>Мои предметы</span>
                    <span class="sub" style="margin:0; min-height:auto;">прокрутка</span>
                  </div>
                  <div class="marketList" id="myItemsList"></div>
                </div>
          
                <!-- RIGHT: market listings -->
                <div class="marketPanel">
                  <div class="marketPanelTitle">
                    <span>Предметы на рынке</span>
                    <span class="sub" style="margin:0; min-height:auto;">в продаже</span>
                  </div>
                  <div class="marketList" id="marketItemsList"></div>
                </div>
              </div>
            </div>
          </div>


          <!-- PROFILE -->
          <div id="viewProfile" style="display:none;">
            <div class="profileView">
              <div class="profileTitle">
                <span>Профиль</span>
                <button class="btn2" id="closeProfileBtn" type="button">Закрыть</button>
              </div>

              <div class="profileText" id="profileText"></div>

              <div class="pwBox">
                <div class="pwTitle">Смена пароля</div>

                <div class="pwGrid">
                  <div class="pwRow">
                    <input class="field" id="oldPass" type="password" placeholder="Старый пароль" autocomplete="current-password" />
                    <input class="field" id="newPass" type="password" placeholder="Новый пароль (мин. 6)" autocomplete="new-password" />
                  </div>
                  <button class="btn" id="changePassBtn" type="button">Сменить пароль</button>
                  <div class="hint" id="pwHint">Не используй простой пароль!</div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- PROFILE MODAL -->
<div class="modal" id="profileModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
    <div class="modalHead">
      <div class="modalTitle" id="profileModalTitle">Профиль</div>
      <button class="modalClose" id="profileModalClose" type="button">✕</button>
    </div>

    <div class="modalBody">
      <div class="pRow">
        <div class="pLabel">Баланс</div>
        <div class="pValue" id="pmBalance">$0</div>
      </div>

      <div class="pRow">
        <div class="pLabel">Ник</div>
        <div class="pValue" id="pmNick">—</div>
      </div>

      <div class="pRow">
        <div class="pLabel">Логин</div>
        <div class="pValue mono" id="pmLogin">—</div>
      </div>

      <div class="pRow">
        <div class="pLabel">Пароль</div>
        <div class="pValue passLine">
          <span class="mono" id="pmPassMasked">******</span>
          <span class="mono" id="pmPassPlain" style="display:none;"></span>
          <button class="btn2 tiny" id="pmTogglePass" type="button">Показать</button>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Пароль показывается только локально
      </div>
    </div>
  </div>
</div>

<div class="modal" id="adminModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
    <div class="modalHead">
      <div class="modalTitle" id="adminModalTitle">Админка — предметы</div>
      <button class="modalClose" id="adminModalClose" type="button">✕</button>
    </div>

    <div class="modalBody">
      <div class="hint">Кол-во “в продаже” считается по активным лотам и не редактируется.</div>

      <div class="pwBox" style="margin-top:12px;">
        <div class="pwTitle">Добавить / Изменить предмет</div>

        <div class="pwGrid">
          <input class="field" id="admItemId" placeholder="ID (пусто = новый)" />
          <input class="field" id="admName" placeholder="Название" />
          <input class="field" id="admImageUrl" placeholder="Картинка (URL)" />
          <input class="field" id="admPrice" placeholder="Цена (число)" type="number" />

          <div class="row">
            <button class="btn" id="admSaveBtn" type="button">Сохранить</button>
            <button class="btn2" id="admClearBtn" type="button">Очистить</button>
          </div>

          <button class="btn2" id="admDeleteBtn" type="button" disabled>Удалить выбранный</button>
        </div>
      </div>

      <div class="pwBox">
        <div class="pwTitle">Список предметов</div>
        <div id="admList" class="marketList" style="max-height:340px;"></div>
      </div>
    </div>
  </div>
</div>

  


  <div class="toast" id="toast"></div>

  <!-- LOGO (перенесён внизу слева) -->
  <div class="logoOrb" id="logoOrb" title="WORLD_SCRIPT">
    <img src="IconWorld.png" alt="WORLD_SCRIPT logo">
  </div>

  <button class="logoutBtn" id="logoutBtn" type="button" title="Выйти из аккаунта">
    Выйти из аккаунта
  </button>


  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // ======================
    // Supabase
    // ======================
    var SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    function $(id){ return document.getElementById(id); }

    var btnAdmin = $("btnAdmin");
    var logoutBtn = $("logoutBtn");

    var adminModal = $("adminModal");
    var adminModalClose = $("adminModalClose");
    
    var admItemId = $("admItemId");
    var admName = $("admName");
    var admImageUrl = $("admImageUrl");
    var admPrice = $("admPrice");
    
    var admSaveBtn = $("admSaveBtn");
    var admClearBtn = $("admClearBtn");
    var admDeleteBtn = $("admDeleteBtn");
    var admList = $("admList");


    var profileBox = $("profileBox");
    var profileModal = $("profileModal");
    var profileModalClose = $("profileModalClose");
    var pmBalance = $("pmBalance");
    var pmNick = $("pmNick");
    var pmLogin = $("pmLogin");
    var pmPassMasked = $("pmPassMasked");
    var pmPassPlain = $("pmPassPlain");
    var pmTogglePass = $("pmTogglePass");

    var viewMarket = $("viewMarket");
    var exitMenuBtn = $("exitMenuBtn");
    var myItemsList = $("myItemsList");
    var marketItemsList = $("marketItemsList");
    

    
    var authWrap = $("authWrap");
    var shell = $("shell");
    var msg = $("msg");

    var tLogin = $("tLogin"), tReg = $("tReg");
    var loginForm = $("loginForm"), regForm = $("regForm");

    var loginL = $("loginL"), passL = $("passL"), loginBtn = $("loginBtn");
    var loginR = $("loginR"), nickR = $("nickR"), passR = $("passR"), regBtn = $("regBtn");

    var avatarFile = $("avatarFile"), pickAvatar = $("pickAvatar"), avatarName = $("avatarName");
    var avatarPreviewImg = $("avatarPreviewImg");
    var avatarPreviewTxt = $("avatarPreviewTxt");

    var shellAvaBox = $("shellAvaBox");
    var shellAvatar = $("shellAvatar"), shellNick = $("shellNick"), shellLogin = $("shellLogin");
    var avatarChangeFile = $("avatarChangeFile");

    var btnBonus = $("btnBonus");
    var btnRoulette = $("btnRoulette");
    var btnChance = $("btnChance");

    var btnMarket = $("btnMarket"), btnMyItems = $("btnMyItems"), btnGames = $("btnGames");
    var historyGrid = $("historyGrid");

    var onlinePill = $("onlinePill");
    var toast = $("toast");

    var profileText = $("profileText");
    var viewHistory = $("viewHistory");
    var viewProfile = $("viewProfile");
    var balanceValue = $("balanceValue");

    var closeProfileBtn = $("closeProfileBtn");
    var oldPass = $("oldPass"), newPass = $("newPass"), changePassBtn = $("changePassBtn");
    var pwHint = $("pwHint");

    function setMsg(text){ msg.textContent = text || ""; }

    function toastShow(text){
      toast.textContent = text || "";
      toast.classList.add("show");
      clearTimeout(toast.__t);
      toast.__t = setTimeout(function(){ toast.classList.remove("show"); }, 1400);
    }

    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active"); tReg.classList.remove("active");
        loginForm.style.display = "flex"; regForm.style.display = "none";
      } else {
        tReg.classList.add("active"); tLogin.classList.remove("active");
        loginForm.style.display = "none"; regForm.style.display = "flex";
      }
    }

    function validLogin(login){
      return /^[a-zA-Z0-9_]{3,20}$/.test(login);
    }

    // ======================
    // Session
    // ======================
    function saveSession(user){
      localStorage.setItem("game_user", JSON.stringify({
        id: user.id,
        login: user.login,
        nick: user.nick,
        avatar_url: user.avatar_url || null,
        role: user.role || "user",
        plain_pass: user.__plain_pass || null
      }));
    }


    function loadSession(){
      try{
        var s = JSON.parse(localStorage.getItem("game_user") || "null");
        if (s && s.plain_pass) s.__plain_pass = s.plain_pass;
        return s;
      }catch(e){
        return null;
      }
    }

    var HISTORY_MAX = 10;

    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem("game_history") || "[]"); }
      catch(e){ return []; }
    }
    function saveHistory(arr){
      localStorage.setItem("game_history", JSON.stringify(arr || []));
    }

    var currentUser = null;

    function addHistoryItem(text){
      var arr = loadHistory();
      var actor = currentUser ? {
        login: currentUser.login || "—",
        avatar_url: currentUser.avatar_url || null
      } : { login: "—", avatar_url: null };

      arr.unshift({
        at: new Date().toISOString(),
        text: text,
        actor: actor
      });

      if (arr.length > HISTORY_MAX) arr = arr.slice(0, HISTORY_MAX);
      saveHistory(arr);
      renderHistory();
    }

    function fmtTime(iso){
      try{
        var d = new Date(iso);
        var hh = String(d.getHours()).padStart(2,"0");
        var mm = String(d.getMinutes()).padStart(2,"0");
        var ss = String(d.getSeconds()).padStart(2,"0");
        return hh+":"+mm+":"+ss;
      }catch(_){
        return "";
      }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(c){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" })[c];
      });
    }

    function renderHistory(){
      var arr = loadHistory();
      historyGrid.innerHTML = "";

      if (!arr.length){
        var r = document.createElement("div");
        r.className = "hRow";
        r.innerHTML =
          '<div class="hLeft">' +
            '<div class="hDot"></div>' +
            '<div class="hLogin">—</div>' +
          '</div>' +
          '<div class="hItem">' +
            '<div class="hTop"><span>История</span><span>—</span></div>' +
            '<div class="hText">Пока пусто. Нажми “Рулетка” или “Бонус”.</div>' +
          '</div>';
        historyGrid.appendChild(r);
        return;
      }

      for (var i=0;i<arr.length;i++){
        var it = arr[i] || {};
        var actor = it.actor || {};
        var aLogin = actor.login || "—";
        var aAva = actor.avatar_url || null;

        var row = document.createElement("div");
        row.className = "hRow";

        var left =
          '<div class="hLeft">' +
            '<div class="hDot">' + (aAva ? ('<img alt="a" src="'+escapeHtml(aAva)+'" />') : '') + '</div>' +
            '<div class="hLogin">' + escapeHtml(aLogin) + '</div>' +
          '</div>';

        var right =
          '<div class="hItem">' +
            '<div class="hTop"><span>Действие</span><span>'+fmtTime(it.at)+'</span></div>' +
            '<div class="hText">'+escapeHtml(it.text)+'</div>' +
          '</div>';

        row.innerHTML = left + right;
        historyGrid.appendChild(row);
      }
    }

    function svgData(label){
      // простая SVG-иконка как data-uri, чтобы не тянуть внешние картинки
      var safe = String(label || "?").slice(0,2).toUpperCase();
      var svg =
        "<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>" +
        "<defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>" +
        "<stop offset='0' stop-color='%2346dcc8' stop-opacity='.30'/>" +
        "<stop offset='1' stop-color='%23b478ff' stop-opacity='.28'/>" +
        "</linearGradient></defs>" +
        "<rect width='160' height='160' rx='28' ry='28' fill='url(%23g)'/>" +
        "<rect x='10' y='10' width='140' height='140' rx='22' ry='22' fill='%230b0614' fill-opacity='.35'/>" +
        "<text x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' " +
        "font-size='54' fill='white' fill-opacity='.82' font-family='Arial'>" + safe + "</text>" +
        "</svg>";
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }
    
    var TEST_ITEMS = [
      { id:"i1", name:"Aurora Shard",        price: 1200, img: svgData("AS") },
      { id:"i2", name:"Violet Coin",         price: 340,  img: svgData("VC") },
      { id:"i3", name:"Prism Core",          price: 5600, img: svgData("PC") },
      { id:"i4", name:"Nebula Thread",       price: 890,  img: svgData("NT") },
      { id:"i5", name:"Echo Capsule",        price: 2100, img: svgData("EC") },
      { id:"i6", name:"Glitch Relic",        price: 7750, img: svgData("GR") },
      { id:"i7", name:"Cryo Crystal",        price: 1550, img: svgData("CC") },
      { id:"i8", name:"Solar Badge",         price: 640,  img: svgData("SB") },
      { id:"i9", name:"Quantum Tag",         price: 980,  img: svgData("QT") },
      { id:"i10",name:"Void Fragment",       price: 4300, img: svgData("VF") },
    ];
    
    function renderItemRow(it){
      var el = document.createElement("div");
      el.className = "mItem";
      el.innerHTML =
        '<div class="mImg"><img alt="item" src="'+escapeHtml(it.img)+'"></div>' +
        '<div>' +
          '<div class="mName">'+escapeHtml(it.name)+'</div>' +
          '<div class="mSub">ID: '+escapeHtml(it.id)+'</div>' +
        '</div>' +
        '<div class="mPrice">'+money(it.price)+'</div>';
      return el;
    }

    async function loadMyProfile(){
      const res = await supabase.from("profiles").select("*").eq("user_id", (await supabase.auth.getUser()).data.user.id).single();
      if (res.error) throw res.error;
      return res.data;
    }

    
    async function renderMarket(){
      myItemsList.innerHTML = "";
      marketItemsList.innerHTML = "";
    
      const inv = await loadMyInventory();
      const listings = await loadMarket();
    
      // LEFT: inventory
      inv.forEach(row => {
        const it = row.item_catalog;
        const qty = row.qty;
    
        const el = document.createElement("div");
        el.className = "mItem";
        el.innerHTML = `
          <div class="mImg"><img alt="item" src="${escapeHtml(it.image_url || svgData(it.name))}"></div>
          <div>
            <div class="mName">${escapeHtml(it.name)}</div>
            <div class="mSub">В наличии: ${qty}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <div class="mPrice">${money(it.base_price || 0)}</div>
            <button class="btn2 tiny">Продать</button>
          </div>
        `;
        const sellBtn = el.querySelector("button");
        sellBtn.onclick = async () => {
          try{
            // простая форма: цена и количество
            const p = prompt("Цена за 1 шт ($):", String(it.base_price || 0));
            if (p === null) return;
            const price = Math.max(0, parseInt(p,10)||0);
    
            const q = prompt(`Количество (1..${qty}):`, "1");
            if (q === null) return;
            const sellQty = Math.min(qty, Math.max(1, parseInt(q,10)||1));
    
            // RPC
            const r = await supabase.rpc("create_listing_from_inventory", {
              p_item_id: it.id,
              p_qty: sellQty,
              p_price: price
            });
            if (r.error) throw r.error;
    
            toastShow("Лот выставлен!");
            addHistoryItem(`Выставлен лот: ${it.name} x${sellQty} за ${money(price)}`);
            await renderMarket(); // перерисовать
          }catch(e){
            console.error(e);
            toastShow(e?.message || "Ошибка продажи");
          }
        };
    
        myItemsList.appendChild(el);
      });
    
      // RIGHT: market
      listings.forEach(l => {
        const it = l.item_catalog;
        const el = document.createElement("div");
        el.className = "mItem";
        el.innerHTML = `
          <div class="mImg"><img alt="item" src="${escapeHtml(it.image_url || svgData(it.name))}"></div>
          <div>
            <div class="mName">${escapeHtml(it.name)}</div>
            <div class="mSub">Кол-во: ${l.qty}</div>
          </div>
          <div class="mPrice">${money(l.price)}</div>
        `;
        marketItemsList.appendChild(el);
      });
    }

    
    function openMarketMenu(){
      inMenu = true;
      setGameplayEnabled(false);
      renderMarket();
      showView("market");
      addHistoryItem("Открыт: Рынок предметов");
      toastShow("Рынок открыт");
    }
    
    function closeMarketMenu(){
      inMenu = false;
      setGameplayEnabled(true);
      showView("history");
            // admin button
      if (btnAdmin){
        var isAdmin = (user.role === "admin");
        btnAdmin.style.display = isAdmin ? "" : "none";
      }

      toastShow("Выход из меню");
    }

    function openAdminModal(){
      if (!currentUser || currentUser.role !== "admin") return;
      adminModal.classList.add("active");
      adminModal.setAttribute("aria-hidden","false");
      renderAdminItems(); // загрузка списка
    }
    
    function closeAdminModal(){
      adminModal.classList.remove("active");
      adminModal.setAttribute("aria-hidden","true");
    }
    
    if (btnAdmin) btnAdmin.onclick = openAdminModal;
    if (adminModalClose) adminModalClose.onclick = closeAdminModal;
    
    if (adminModal){
      adminModal.onclick = function(e){
        if (e.target === adminModal) closeAdminModal();
      };
    }

    async function loadCatalog(){
      const res = await supabase
        .from("item_catalog")
        .select("id,name,image_url,base_price")
        .order("created_at", { ascending: false });
    
      if (res.error) throw res.error;
      return res.data || [];
    }
    
    async function loadActiveListings(){
      const res = await supabase
        .from("market_listings")
        .select("item_id,qty")
        .eq("status","active");
    
      if (res.error) throw res.error;
      return res.data || [];
    }
    
    function sumQtyByItem(listings){
      var map = {};
      listings.forEach(l => {
        var k = l.item_id;
        map[k] = (map[k] || 0) + (l.qty || 0);
      });
      return map;
    }
    
    function fillAdminForm(it){
      admItemId.value = it.id || "";
      admName.value = it.name || "";
      admImageUrl.value = it.image_url || "";
      admPrice.value = (it.base_price != null) ? String(it.base_price) : "";
      admDeleteBtn.disabled = !it.id;
    }

    async function renderAdminItems(){
      if (!admList) return;
      admList.innerHTML = "";
    
      try{
        const [items, listings] = await Promise.all([loadCatalog(), loadActiveListings()]);
        const qtyMap = sumQtyByItem(listings);
    
        if (!items.length){
          var e = document.createElement("div");
          e.className = "hint";
          e.textContent = "Пока нет предметов в каталоге.";
          admList.appendChild(e);
          return;
        }
    
        items.forEach(it => {
          var el = document.createElement("div");
          el.className = "mItem";
          var q = qtyMap[it.id] || 0;
    
          el.innerHTML = `
            <div class="mImg"><img alt="item" src="${escapeHtml(it.image_url || svgData(it.name))}"></div>
            <div>
              <div class="mName">${escapeHtml(it.name)}</div>
              <div class="mSub">ID: ${escapeHtml(it.id)} • В продаже: ${q}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <div class="mPrice">${money(it.base_price || 0)}</div>
              <button class="btn2 tiny">Выбрать</button>
            </div>
          `;
    
          el.querySelector("button").onclick = () => {
            fillAdminForm(it);
          };
    
          admList.appendChild(el);
        });
    
      }catch(e){
        console.error(e);
        toastShow(e?.message || "Ошибка загрузки каталога");
      }
    }

    function clearAdminForm(){
      admItemId.value = "";
      admName.value = "";
      admImageUrl.value = "";
      admPrice.value = "";
      admDeleteBtn.disabled = true;
    }
    
    if (admClearBtn) admClearBtn.onclick = clearAdminForm;
    
    if (admSaveBtn) admSaveBtn.onclick = async function(){
      if (!currentUser || currentUser.role !== "admin") return;
    
      try{
        var id = (admItemId.value || "").trim();
        var name = (admName.value || "").trim();
        var image_url = (admImageUrl.value || "").trim();
        var base_price = Math.max(0, parseInt(admPrice.value || "0", 10) || 0);
    
        if (!name){ toastShow("Название обязательно"); return; }
    
        // upsert: если id пустой — вставляем, иначе обновляем
        if (!id){
          const ins = await supabase.from("item_catalog").insert({
            name, image_url: image_url || null, base_price
          }).select("id").single();
          if (ins.error) throw ins.error;
    
          toastShow("Предмет добавлен");
          addHistoryItem(`Админ: добавлен предмет "${name}"`);
          clearAdminForm();
          await renderAdminItems();
          return;
        }
    
        const upd = await supabase.from("item_catalog").update({
          name, image_url: image_url || null, base_price
        }).eq("id", id);
    
        if (upd.error) throw upd.error;
    
        toastShow("Сохранено");
        addHistoryItem(`Админ: обновлён предмет "${name}"`);
        await renderAdminItems();
    
      }catch(e){
        console.error(e);
        toastShow(e?.message || "Ошибка сохранения");
      }
    };
    
    if (admDeleteBtn) admDeleteBtn.onclick = async function(){
      if (!currentUser || currentUser.role !== "admin") return;
    
      try{
        var id = (admItemId.value || "").trim();
        if (!id) return;
    
        // ВАЖНО: удаление может быть запрещено, если предмет используется в inventory/market_listings (FK).
        const del = await supabase.from("item_catalog").delete().eq("id", id);
        if (del.error) throw del.error;
    
        toastShow("Удалено");
        addHistoryItem(`Админ: удалён предмет ID ${id}`);
        clearAdminForm();
        await renderAdminItems();
    
      }catch(e){
        console.error(e);
        toastShow(e?.message || "Ошибка удаления (возможно, предмет используется)");
      }
    };



    function openProfileModal(){
      if (!currentUser) return;
    
      // заполняем поля
      pmNick.textContent = currentUser.nick || "—";
      pmLogin.textContent = currentUser.login ? ("@" + currentUser.login) : "—";
    
      // баланс берём из profileState как у тебя
      var bal = 0;
      if (profileState){
        bal = (profileState.bonus || 0) + (profileState.gameBonus || 0);
      }
      pmBalance.textContent = money(bal);
    
      // пароль: покажем только если ты сохранил его в сессии
      // (см. пункт D ниже)
      var pass = (currentUser && currentUser.__plain_pass) ? String(currentUser.__plain_pass) : "";
      pmPassPlain.textContent = pass ? pass : "—";
      pmPassMasked.textContent = pass ? "********" : "—";
      pmPassPlain.style.display = "none";
      pmPassMasked.style.display = "";
      pmTogglePass.textContent = "Показать";
      pmTogglePass.disabled = !pass;
    
      profileModal.classList.add("active");
      profileModal.setAttribute("aria-hidden","false");
    }
    
    function closeProfileModal(){
      profileModal.classList.remove("active");
      profileModal.setAttribute("aria-hidden","true");
    }
    
    // клики/ESC
    if (profileBox){
      profileBox.onclick = openProfileModal;
      profileBox.onkeydown = function(e){
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openProfileModal();
        }
      };
    }
    
    if (profileModalClose) profileModalClose.onclick = closeProfileModal;
    
    if (profileModal){
      profileModal.onclick = function(e){
        if (e.target === profileModal) closeProfileModal();
      };
    }
    
    window.addEventListener("keydown", function(e){
      if (e.key === "Escape" && profileModal && profileModal.classList.contains("active")){
        closeProfileModal();
      }
    });
    
    if (pmTogglePass){
      pmTogglePass.onclick = function(){
        var showing = pmPassPlain.style.display !== "none";
        if (showing){
          pmPassPlain.style.display = "none";
          pmPassMasked.style.display = "";
          pmTogglePass.textContent = "Показать";
        } else {
          pmPassPlain.style.display = "";
          pmPassMasked.style.display = "none";
          pmTogglePass.textContent = "Скрыть";
        }
      };
    }
    

    
    function money(n){
      n = Math.floor(Number(n || 0));
      return "$" + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function fmtLeft(ms){
      ms = Math.max(0, ms|0);
      var s = Math.floor(ms/1000);
      var d = Math.floor(s/86400); s -= d*86400;
      var h = Math.floor(s/3600);  s -= h*3600;
      var m = Math.floor(s/60);    s -= m*60;
      return d+"д "+h+"ч "+m+"мин";
    }
    function profileKey(login){ return "profile_state_" + (login || ""); }

    function defaultProfile(){
      var now = Date.now();
      return {
        pseudo: "Бабабуй",
        emodji: "Нет",
        marriage: "Нет",
        clan: "Нет",
        autoRoulette: "Нет",
        takenBonus: 0,
        frozen: 500000,

        rouletteRating: 18.9,
        rouletteRank: 6,
        rouletteRankTitle: "МегаПользователь",
        activityRating: 6.2,
        activityPlace: 15,

        bonus: 20355,
        gameBonus: 0,
        nickText: "Shadow Smith",
        inGame: false,

        repEarned: 53002,
        repIssued: 39,
        repCashback: 11501,

        t_x2: false,
        t_eternal: false,
        t_x3_stream: false,
        t_auto: false,

        lockTakeBonusUntil: now + (2*86400 + 6*3600 + 29*60) * 1000,
        chanceUntil: now + (1*86400 + 4*3600 + 11*60) * 1000,
        bonusResetUntil: now + (6*86400 + 7*3600 + 29*60) * 1000,
        bonusUntil: now + (5*3600) * 1000,
        rouletteUntil: now + (1*86400) * 1000,

        bonusTimeMs: (10*3600 + 36*60) * 1000
      };
    }

    function loadProfileState(user){
      try{
        var k = profileKey(user.login);
        var raw = localStorage.getItem(k);
        if (!raw) return defaultProfile();
        var st = JSON.parse(raw);
        if (!st || typeof st !== "object") return defaultProfile();
        return st;
      }catch(e){
        return defaultProfile();
      }
    }
    function saveProfileState(user, st){
      try{
        localStorage.setItem(profileKey(user.login), JSON.stringify(st));
      }catch(e){}
    }

    var profileState = null;
    var profileTimer = null;

    function updateBalanceUI(){
      var bal = 0;
      if (profileState){
        bal = (profileState.bonus || 0) + (profileState.gameBonus || 0);
      }
      balanceValue.textContent = money(bal);
    }

    function renderProfile(){
      if (!currentUser || !profileState) return;

      var now = Date.now();
      var lockLeft = fmtLeft(profileState.lockTakeBonusUntil - now);

      var txt =
`🆔 Пользователь ${currentUser.login}:

ℹ Рейтинг рулетки: ${profileState.rouletteRating.toFixed(1)}, ранг «${profileState.rouletteRank}»: ${profileState.rouletteRankTitle} (подробнее: «Рулетка инфо»)
⤴ Рейтинг активности: ${profileState.activityRating.toFixed(1)} (подробнее: «Рейтинг»)
На ${profileState.activityPlace} месте в топе актива!

🅱 Бонус: ${money(profileState.bonus)}
⛏ Бонус с игры: ${money(profileState.gameBonus)}
🔗 Ник: ${profileState.nickText} (${profileState.inGame ? "в игре" : "не в игре"})
🔸 Нельзя забирать бонус ${lockLeft}

😏 Кэшбек Репутации (подробнее: «Репутация»)
— Заработано: ${money(profileState.repEarned)}
— Выдано: ${profileState.repIssued} шт
— Кэшбек: ${money(profileState.repCashback)}

🔝 Тарифы (подробнее: «Тариф инфо»):
${profileState.t_x2 ? "✅" : "❌"} Х2 бонусы с 12:00 до 18:00 
${profileState.t_eternal ? "✅" : "❌"} Вечный Ранг / Псевд / Эмодзи
${profileState.t_x3_stream ? "✅" : "❌"} Х3 в зоне стрима бота 
${profileState.t_auto ? "✅" : "❌"} Авторулетка 

⏲ Время до:
» Шанса: ${fmtLeft(profileState.chanceUntil - now)}
» Обнуления бонуса: ${fmtLeft(profileState.bonusResetUntil - now)}
» Бонуса: ${fmtLeft(profileState.bonusUntil - now)}
» Рулетки: ${fmtLeft(profileState.rouletteUntil - now)}

👫 Брак: ${profileState.marriage}
🆑 Клан: ${profileState.clan}

Ⓜ EMODJI: ${profileState.emodji}
🀄 Псевдоним: ${profileState.pseudo}
🔁 Автопрокр. рулетки в запасе: ${profileState.autoRoulette}
📂 Забрано бонуса: ${money(profileState.takenBonus)}
❄ Заморожено: ${money(profileState.frozen)}
⌛ Бонусное время: ${fmtLeft(profileState.bonusTimeMs)}`;

      profileText.textContent = txt;
      updateBalanceUI();
    }

    function showView(name){
      // прячем всё
      viewHistory.style.display = "none";
      viewProfile.style.display = "none";
      if (viewMarket) viewMarket.style.display = "none";
    
      if (name === "profile"){
        viewProfile.style.display = "block";
        renderProfile();
        return;
      }
    
      if (name === "market"){
        if (viewMarket) viewMarket.style.display = "block";
        return;
      }
    
      // default: history
      viewHistory.style.display = "block";
    }


    function startProfileTicker(){
      if (profileTimer) clearInterval(profileTimer);
      profileTimer = setInterval(function(){
        if (profileState && profileState.bonusTimeMs > 0){
          profileState.bonusTimeMs = Math.max(0, profileState.bonusTimeMs - 1000);
          if (currentUser) saveProfileState(currentUser, profileState);
        }
        if (viewProfile.style.display !== "none") renderProfile();
        else updateBalanceUI();
      }, 1000);
    }

    // ======================
  // Supabase init
  // ======================
  if (!window.supabase || !window.supabase.createClient){
    setMsg("Supabase SDK не загрузился (CDN).");
    return;
  }
  var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ======================
  // Пароль: SHA-256
  // ======================
  async function sha256(text){
    var enc = new TextEncoder().encode(text);
    var buf = await crypto.subtle.digest("SHA-256", enc);
    var arr = Array.from(new Uint8Array(buf));
    return arr.map(function(b){ return b.toString(16).padStart(2,"0"); }).join("");
  }

  async function getUserByLogin(loginLower){
    var res = await supabase.from("game_users")
      .select("id,login,nick,pass_hash,avatar_url,role")
      .eq("login", loginLower)
      .maybeSingle();
    if (res.error) throw res.error;
    return res.data || null;
  }

  async function existsByField(field, value){
    var q = supabase.from("game_users").select("id").limit(1);
    if (field === "login") q = q.eq("login", value);
    else q = q.ilike("nick", value);
    var res = await q;
    if (res.error) throw res.error;
    return res.data && res.data.length > 0;
  }

  // ======================
  // Online presence
  // ======================
  var onlineTimer = null;

  async function heartbeatOnline(user){
    try{
      await supabase.from("online_presence").upsert({
        user_id: user.id,
        login: user.login,
        nick: user.nick,
        last_seen: new Date().toISOString()
      });
    }catch(e){}
  }

  async function refreshOnlineCount(){
    try{
      var since = new Date(Date.now() - 60*1000).toISOString();
      var res = await supabase.from("online_presence")
        .select("user_id", { count: "exact", head: true })
        .gte("last_seen", since);
      if (res.error) throw res.error;
      onlinePill.textContent = String(res.count || 0);
    }catch(e){
      onlinePill.textContent = "—";
    }
  }

  function startOnline(user){
    if (onlineTimer) clearInterval(onlineTimer);
    heartbeatOnline(user);
    refreshOnlineCount();
    onlineTimer = setInterval(function(){
      heartbeatOnline(user);
      refreshOnlineCount();
    }, 15000);
  }

  // ======================
  // UI switch
  // ======================

  var inMenu = false;

  function setGameplayEnabled(enabled){
    // left buttons
    [btnBonus, btnRoulette, btnChance].forEach(function(b){
      if (!b) return;
      b.disabled = !enabled;
      b.classList.toggle("dimmed", !enabled);
    });
  }

  function clearSession(){
    localStorage.removeItem("game_user");
  }

  if (logoutBtn){
    logoutBtn.onclick = doLogout;
  }

  
  async function doLogout(){
    try{
      // закрыть модалки если открыты
      if (profileModal && profileModal.classList.contains("active")) closeProfileModal();
      if (typeof closeAdminModal === "function" && adminModal && adminModal.classList.contains("active")) closeAdminModal();
  
      // остановить таймеры
      if (onlineTimer) clearInterval(onlineTimer);
      onlineTimer = null;
  
      if (profileTimer) clearInterval(profileTimer);
      profileTimer = null;
  
      // (опционально) можно попытаться удалить presence, но это не обязательно
      // if (currentUser) await supabase.from("online_presence").delete().eq("user_id", currentUser.id);
  
      // сброс локальных данных
      clearSession();
      currentUser = null;
      profileState = null;
  
      toastShow("Вы вышли из аккаунта");
      showAuth();
    }catch(e){
      console.error(e);
      clearSession();
      showAuth();
    }
  }

    
  function showShell(user){
    authWrap.style.display = "none";
    shell.style.display = "block";

    shellNick.textContent = user.nick || "—";
    shellLogin.textContent = user.login ? ("@" + user.login) : "—";

    if (user.avatar_url) shellAvatar.src = user.avatar_url;

    if (logoutBtn) logoutBtn.style.display = "";
    
    currentUser = user;
    profileState = loadProfileState(user);
    updateBalanceUI();
    startProfileTicker();

    renderHistory();
    startOnline(user);

    setGameplayEnabled(true);
    inMenu = false;


    // теперь по умолчанию показываем историю
    showView("history");
  }

  function showAuth(){
    shell.style.display = "none";
    authWrap.style.display = "flex";
    showTab("login");
    setMsg("");
    onlinePill.textContent = "—";

    if (logoutBtn) logoutBtn.style.display = "none";
      
    if (onlineTimer) clearInterval(onlineTimer);
    onlineTimer = null;

    currentUser = null;
    profileState = null;
    if (profileTimer) clearInterval(profileTimer);
    profileTimer = null;
  }

  // ======================
  // AUTH Events
  // ======================
  tLogin.onclick = function(){ showTab("login"); };
  tReg.onclick = function(){ showTab("reg"); };

  // регистрационный аватар (оставил как было — твой код сжатия ниже у тебя большой,
  // тут не трогаю, чтобы не ломать. Просто оставь его в своём файле как раньше.)
  var regAvatarDataUrl = null;

  pickAvatar.onclick = function(){ avatarFile.click(); };

  // ВАЖНО: оставь твой обработчик avatarFile.onchange (сжатие) как был в исходнике.
  // Здесь не вставляю, чтобы не раздуть ответ.

  loginBtn.onclick = async function(){
    setMsg("");
    try{
      var login = (loginL.value || "").trim().toLowerCase();
      var pass = passL.value || "";
      if (!login || !pass){ setMsg("Введи логин и пароль"); return; }

      var user = await getUserByLogin(login);
      if (!user){ setMsg("Неверный логин или пароль"); return; }

      var hash = await sha256(pass);
      if (hash !== user.pass_hash){ setMsg("Неверный логин или пароль"); return; }

      var sessionUser = { id:user.id, login:user.login, nick:user.nick, avatar_url:user.avatar_url };
      sessionUser.__plain_pass = pass;
      saveSession(sessionUser);
      showShell(sessionUser);
      toastShow("Добро пожаловать, " + user.nick + "!");
    }catch(e){
      console.error(e);
      setMsg(e && e.message ? e.message : String(e));
    }
  };

  regBtn.onclick = async function(){
    setMsg("");
    try{
      var login = (loginR.value || "").trim().toLowerCase();
      var nick = (nickR.value || "").trim();
      var pass = passR.value || "";

      if (!login || !nick || !pass){ setMsg("Заполни поля"); return; }
      if (!validLogin(login)){ setMsg("Логин: 3–20 символов, только латиница/цифры/_"); return; }
      if (pass.length < 6){ setMsg("Пароль минимум 6 символов"); return; }

      if (await existsByField("login", login)){ setMsg("Такой логин уже занят"); return; }
      if (await existsByField("nick", nick)){ setMsg("Такой ник уже занят"); return; }

      var hash = await sha256(pass);
      var avatarUrl = regAvatarDataUrl || null;

      var ins = await supabase.from("game_users").insert({
        login: login,
        nick: nick,
        pass_hash: hash,
        avatar_url: avatarUrl
      }).select("id,login,nick,pass_hash,avatar_url,role").single();

      if (ins.error){
        console.error(ins.error);
        setMsg(ins.error.message || "Ошибка регистрации");
        return;
      }

      var u = ins.data;
      u.__plain_pass = pass;
      saveSession(u);
      showShell(u);
      addHistoryItem("Создан аккаунт");
      toastShow("Аккаунт создан!");
    }catch(e){
      console.error(e);
      setMsg(e && e.message ? e.message : String(e));
    }
  };

  // ======================
  // SHELL Events (игровые кнопки)
  // ======================
  function demoRouletteSpin(){
    var outcomes = [
      "Выпал предмет: Aurora Shard",
      "Выпал предмет: Violet Coin",
      "Ничего не выпало… но шанс растёт",
      "Выпал предмет: Prism Core",
      "Бонус: +1 попытка (демо)"
    ];
    return outcomes[Math.floor(Math.random() * outcomes.length)];
  }

  btnBonus.onclick = function(){
    if (!profileState || !currentUser) return;
    var add = 250 + Math.floor(Math.random()*501);
    profileState.bonus += add;
    profileState.lockTakeBonusUntil = Math.max(profileState.lockTakeBonusUntil, Date.now() + 2*3600*1000);

    saveProfileState(currentUser, profileState);
    updateBalanceUI();
    if (viewProfile.style.display !== "none") renderProfile();

    addHistoryItem("Бонус: +" + money(add));
    toastShow("Бонус +" + money(add));
    showView("history");
  };

  btnRoulette.onclick = function(){
    if (!profileState || !currentUser) return;
    var x = demoRouletteSpin();
    profileState.activityRating = Math.min(99.9, profileState.activityRating + 0.05);
    profileState.rouletteUntil = Math.max(profileState.rouletteUntil, Date.now() + 24*3600*1000);

    saveProfileState(currentUser, profileState);
    updateBalanceUI();
    if (viewProfile.style.display !== "none") renderProfile();

    addHistoryItem("Рулетка: " + x);
    toastShow(x);
    showView("history");
  };

  btnChance.onclick = function(){
    if (!profileState || !currentUser) return;

    profileState.chanceUntil = Math.max(profileState.chanceUntil, Date.now() + 24*3600*1000);
    profileState.activityRating = Math.min(99.9, profileState.activityRating + 0.10);

    saveProfileState(currentUser, profileState);
    updateBalanceUI();
    if (viewProfile.style.display !== "none") renderProfile();

    addHistoryItem("Шанс: обновлён (демо)");
    toastShow("Шанс ↑");
    showView("history");
  };


  // Навигация справа (оставляем, но ведём в историю)
  btnMarket.onclick = function(){
    openMarketMenu();
  };

  if (exitMenuBtn){
    exitMenuBtn.onclick = closeMarketMenu;
  }


  btnMyItems.onclick = function(){ showView("history"); addHistoryItem("Открыто: Мои предметы"); toastShow("Мои предметы"); };
  btnGames.onclick = function(){ showView("history"); addHistoryItem("Открыто: Игры"); toastShow("Игры"); };

  // ======================
  // init session
  // ======================
  (function(){
    var s = loadSession();
    if (s && s.login) showShell(s);
    else showAuth();
  })();

  // ======================
  // Параллакс мышью (как было)
  // ======================
  window.addEventListener("mousemove", function(e){
    var cx = window.innerWidth / 2;
    var cy = window.innerHeight / 2;
    var dx = (e.clientX - cx);
    var dy = (e.clientY - cy);
    document.documentElement.style.setProperty("--parX", dx.toFixed(0) + "px");
    document.documentElement.style.setProperty("--parY", dy.toFixed(0) + "px");
  }, { passive:true });

  async function loadMyInventory(){
  const res = await supabase
    .from("inventory")
    .select("qty, item_catalog: item_id ( id, name, image_url, base_price )")
    .order("updated_at", { ascending: false });

    if (res.error) throw res.error;
    return res.data || [];
  }
  
  async function loadMarket(){
    const res = await supabase
      .from("market_listings")
      .select("id, qty, price, created_at, item_catalog: item_id ( id, name, image_url, base_price ), seller_id")
      .eq("status", "active")
      .order("created_at", { ascending: false });
  
    if (res.error) throw res.error;
    return res.data || [];
  }


})();
  </script> 
  </body> 
</html>
