<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WORLD_SCRIPT</title>
  <link rel="icon" type="image/png" href="IconWorld.png">
  <link rel="apple-touch-icon" href="IconWorld.png">
  <meta name="theme-color" content="#0b0614">

  <style>
    :root{
      --bg0:#07040a;
      --bg1:#0b0614;

      --panel: rgba(12, 8, 14, .74);
      --text: rgba(255,245,240,.94);
      --muted: rgba(255,220,210,.62);

      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --parX: 0px;
      --parY: 0px;

      --accA: rgba(70,220,200,.85);
      --accB: rgba(180,120,255,.85);

      --danger: rgba(255, 100, 120, .95);
      --ok: rgba(120, 255, 190, .95);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* ======= –ü–†–ò–Ø–¢–ù–´–ô –ì–†–ê–î–ò–ï–ù–¢–ù–´–ô –§–û–ù ======= */
    .bgRoot{
      position: fixed;
      inset: 0;
      z-index: -10;
      overflow: hidden;
      background: #07040a;
    }
    .bgLayer{
      position:absolute;
      inset:-15%;
      background:
        radial-gradient(900px 540px at 18% 18%, rgba(90,140,255,.16), transparent 60%),
        radial-gradient(820px 520px at 78% 30%, rgba(180,120,255,.12), transparent 62%),
        radial-gradient(900px 620px at 55% 90%, rgba(70,220,200,.10), transparent 62%),
        linear-gradient(180deg, #0a0615, #07040a);
      background-size: cover;
      background-position: center;
      filter: blur(18px) saturate(1.15) contrast(1.05);
      transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08);
      opacity: .85;
      will-change: transform;
      animation: slowPan 26s ease-in-out infinite;
    }
    @keyframes slowPan{
      0%   { background-position: 30% 35%; transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08); }
      50%  { background-position: 70% 55%; transform: translate(calc(var(--parX) * 0.05), calc(var(--parY) * 0.05)) scale(1.12); }
      100% { background-position: 30% 35%; transform: translate(calc(var(--parX) * 0.03), calc(var(--parY) * 0.03)) scale(1.08); }
    }
    .bgLayer.alt{
      opacity: .55;
      filter: blur(22px) saturate(1.20) contrast(1.06);
      animation-duration: 32s;
    }

    .bgTint{
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 25% 25%, rgba(120,160,255,.12), transparent 60%),
        radial-gradient(980px 620px at 75% 70%, rgba(190,120,255,.10), transparent 62%),
        radial-gradient(1100px 800px at 50% 120%, rgba(0,0,0,.62), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.58));
      pointer-events:none;
      z-index: 2;
    }

    .smoke{
      position:absolute;
      inset:-20%;
      pointer-events:none;
      z-index: 3;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(120,160,255,.08), transparent 60%),
        radial-gradient(820px 480px at 80% 30%, rgba(190,120,255,.07), transparent 58%),
        radial-gradient(780px 520px at 60% 80%, rgba(70,220,200,.06), transparent 60%),
        radial-gradient(680px 460px at 30% 70%, rgba(255,255,255,.03), transparent 62%);
      filter: blur(28px);
      opacity: .55;
      animation: smokeMove 18s ease-in-out infinite;
      transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12);
      will-change: transform;
    }
    @keyframes smokeMove{
      0%   { transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12) rotate(0deg); }
      50%  { transform: translate(calc(var(--parX) * 0.04), calc(var(--parY) * 0.04)) scale(1.18) rotate(1.2deg); }
      100% { transform: translate(calc(var(--parX) * 0.02), calc(var(--parY) * 0.02)) scale(1.12) rotate(0deg); }
    }

    /* ===== AUTH CARD ===== */
    .authWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .card{
      width: min(540px, 100%);
      border-radius: var(--r1);
      background: linear-gradient(180deg, rgba(18,10,18,.78), rgba(8,6,10,.64));
      border: 1px solid rgba(180, 120, 255, .30);
      backdrop-filter: blur(14px);
      padding: 14px;
      box-shadow:
        0 30px 90px rgba(0,0,0,.55),
        0 0 0 1px rgba(180,120,255,.10),
        0 0 40px rgba(180,120,255,.10);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 5%, rgba(120,160,255,.14), transparent 60%),
        radial-gradient(520px 240px at 90% 20%, rgba(190,120,255,.12), transparent 55%),
        radial-gradient(520px 260px at 48% 120%, rgba(70,220,200,.10), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .card > *{ position:relative; z-index:1; }

    .title{
      font-weight: 1000;
      letter-spacing: .14em;
      color: rgba(255,255,255,.86);
      font-size: 12px;
      text-transform: uppercase;
      filter: drop-shadow(0 0 12px rgba(180,120,255,.22));
    }

    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      white-space: pre-line;
    }

    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.88);
      font-weight: 950;
      font-size: 12px;
      user-select:none;
      transition: .14s transform, .14s box-shadow, .14s border-color;
      text-transform: uppercase;
      letter-spacing:.08em;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow: 0 0 18px rgba(180,120,255,.12); }
    .tab.active{
      border-color: rgba(180,120,255,.55);
      background: rgba(255,255,255,.07);
      box-shadow: 0 0 20px rgba(180,120,255,.14);
    }

    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }

    /* ===== Button states (loading/disabled) ===== */
    .btn, .btn2, .miniBtn, .sideBtn, .navBtn{
      -webkit-tap-highlight-color: transparent;
    }
    .btn{
      border-radius: 14px;
      border: 1px solid rgba(180, 120, 255, .60);
      background: linear-gradient(135deg, rgba(90,140,255,.18), rgba(180,120,255,.12));
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.94);
      transition: .14s transform, .14s box-shadow, .14s border-color, .14s opacity;
      text-transform: uppercase;
      letter-spacing: .08em;
      box-shadow:
        0 0 18px rgba(180,120,255,.14),
        0 20px 60px rgba(0,0,0,.35);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height: 42px;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow:
        0 0 26px rgba(180,120,255,.22),
        0 0 55px rgba(90,140,255,.14),
        0 26px 70px rgba(0,0,0,.45);
      border-color: rgba(70, 220, 200, .70);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      min-height: 42px;
    }
    .btn2:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.12); }
    .btn2:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .spinner{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      border-top-color: rgba(70,220,200,.90);
      animation: spin .7s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.35; }

    /* preview for reg avatar */
    .avatarPreview{
      margin-top: 8px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .avatarPreview .bubble{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 2px solid rgba(190,120,255,.75);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      box-shadow: 0 0 20px rgba(190,120,255,.14);
      flex:0 0 auto;
    }
    .avatarPreview img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatarPreview .txt{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    /* ===== GAME SHELL ===== */
    .shell{
      display:none;
      min-height:100vh;
      padding: 18px;
      position:relative;
    }

    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      align-items:start;
    }

    .panel{
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(18,10,18,.78), rgba(8,6,10,.64));
      border: 1px solid rgba(180, 120, 255, .28);
      backdrop-filter: blur(12px);
      box-shadow:
        0 26px 70px rgba(0,0,0,.45),
        0 0 0 1px rgba(180, 120, 255, .10),
        0 0 40px rgba(180, 120, 255, .10);
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(540px 260px at 12% 10%, rgba(90,140,255,.16), transparent 60%),
        radial-gradient(520px 260px at 92% 22%, rgba(190,120,255,.12), transparent 58%),
        radial-gradient(520px 260px at 48% 120%, rgba(70,220,200,.10), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .panel > *{ position:relative; z-index:1; }

    .sidebar{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 520px;
    }

    .profileBox{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }

    .ava{
      width:64px;height:64px;border-radius:999px;
      border: 2px solid rgba(190, 120, 255, .75);
      box-shadow: 0 0 26px rgba(190,120,255,.18);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      cursor:pointer;
      position:relative;
    }
    .ava:after{
      content:"–°–º–µ–Ω–∏—Ç—å";
      position:absolute;
      inset:auto 6px 6px 6px;
      font-size:10px;
      color: rgba(255,255,255,.82);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 2px 6px;
      text-align:center;
      opacity: 0;
      transform: translateY(4px);
      transition: .14s;
      pointer-events:none;
      backdrop-filter: blur(10px);
    }
    .ava:hover:after{ opacity:1; transform: translateY(0); }
    .ava img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pNick{ font-weight:1000; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pLogin{ margin-top:6px; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .sideGrid{
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: repeat(4, 1fr);
      gap: 10px;
    }

    .sideBtn{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s filter,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      padding: 12px;
      min-height: 46px;
    }
    .sideBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(180,120,255,.38);
      box-shadow: 0 0 18px rgba(180,120,255,.12);
    }
    .sideBtn.hot{
      border-color: rgba(70,220,200,.60);
      background: linear-gradient(135deg, rgba(70,220,200,.14), rgba(190,120,255,.10));
      box-shadow: 0 0 18px rgba(180,120,255,.10);
    }
    .sideBtn.hot:before{
      content:"";
      position:absolute;
      inset:-60px;
      background: radial-gradient(circle, rgba(70, 220, 200, .14), transparent 60%);
      animation: pulseGlow 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulseGlow{
      0%,100%{ opacity:.55; transform: translateX(-6px); }
      50%{ opacity:1; transform: translateX(6px); }
    }

    /* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ */
    .sideBtn.active,
    .navBtn.active{
      border-color: rgba(70,220,200,.80);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(70,220,200,.14),
        0 0 50px rgba(90,140,255,.10);
      filter: saturate(1.05);
    }
    .sideBtn.active:after,
    .navBtn.active:after{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(70,220,200,.14), transparent 60%);
      opacity: .85;
      pointer-events:none;
      animation: activePulse 2.6s ease-in-out infinite;
    }
    @keyframes activePulse{
      0%,100%{ transform: translateX(-6px); opacity:.55; }
      50%{ transform: translateX(6px); opacity:1; }
    }

    .sideBtn:disabled,
    .navBtn:disabled,
    .miniBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
      filter:none !important;
    }

    .sideActions{
      display:flex; gap:10px;
      margin-top: 2px;
    }
    .miniBtn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      min-height: 42px;
      position:relative;
      overflow:hidden;
    }
    .miniBtn:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.12); }

    .sidebarBottom{ margin-top:auto; }

    .balanceBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .balanceTitle{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.08em;
      font-weight: 900;
    }
    .balanceValue{
      margin-top: 8px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.02em;
      filter: drop-shadow(0 0 14px rgba(180,120,255,.20));
    }

    .main{ padding: 14px; min-height: 520px; }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .navRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    .navBtn{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color,.14s opacity;
      text-transform: uppercase;
      letter-spacing:.08em;
      position:relative;
      overflow:hidden;
      min-height: 42px;
    }
    .navBtn:hover{ transform: translateY(-1px); border-color: rgba(180,120,255,.35); box-shadow:0 0 18px rgba(180,120,255,.10); }

    .navBtn.market{
      border-color: rgba(70,220,200,.60);
      background: linear-gradient(135deg, rgba(70,220,200,.14), rgba(190,120,255,.10));
      box-shadow: 0 0 22px rgba(180,120,255,.10);
      position:relative;
      overflow:hidden;
    }
    .navBtn.market:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(70,220,200,.14), transparent 60%);
      animation: pulseGlow 2.2s ease-in-out infinite;
      pointer-events:none;
    }

    .onlinePill{
      border-radius: 999px;
      width: 58px;
      height: 58px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 3px solid rgba(70, 220, 200, .70);
      box-shadow:
        0 0 28px rgba(70,220,200,.18),
        0 0 60px rgba(180, 120, 255, .10);
      background: rgba(255,255,255,.03);
      font-weight:1000;
      font-size: 16px;
      position: fixed;
      right: 18px;
      top: 18px;
      z-index: 5;
      user-select:none;
      backdrop-filter: blur(10px);
    }

    /* ===== HOME VIEW ===== */
    .home{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(180,120,255,.45);
      background: rgba(255,255,255,.02);
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
    }
    .homeTitle{
      font-weight: 1000;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .homeHello{
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255,245,240,.92);
      line-height: 1.35;
    }
    .homeCards{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .homeCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 14px;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
      transition: .14s transform, .14s box-shadow, .14s border-color;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-height: 62px;
    }
    .homeCard:hover{
      transform: translateY(-1px);
      border-color: rgba(70,220,200,.35);
      box-shadow:
        0 0 22px rgba(70,220,200,.10),
        0 16px 50px rgba(0,0,0,.35);
    }
    .homeCard .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .homeCard .kicker{
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      font-weight: 1000;
    }
    .homeCard .desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }
    .homeCard .pill{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 1000;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.88);
      flex: 0 0 auto;
      box-shadow: 0 0 18px rgba(180,120,255,.10);
    }
    .homeCard.primary{
      border-color: rgba(70,220,200,.55);
      background: linear-gradient(135deg, rgba(70,220,200,.12), rgba(190,120,255,.08));
    }

    /* ===== –ò—Å—Ç–æ—Ä–∏—è ===== */
    .history{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(180, 120, 255, .50);
      background: rgba(255,255,255,.02);
      padding: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }

    .historyGrid{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .hRow{
      display:grid;
      grid-template-columns: 74px 1fr;
      gap: 12px;
      align-items: stretch;
      min-height: 64px;
    }

    .hLeft{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding-top: 2px;
    }

    .hDot{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 2px solid rgba(180, 120, 255, .70);
      box-shadow: 0 0 18px rgba(180,120,255,.12);
      background: rgba(0,0,0,.12);
      position: relative;
      overflow:hidden;
    }
    .hDot:after{
      content:"";
      position:absolute;
      inset:-10px;
      background: radial-gradient(circle at 30% 30%, rgba(70,220,200,.18), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .hDot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      position:relative;
      z-index:1;
    }

    .hLogin{
      font-size: 10px;
      color: rgba(255,255,255,.78);
      max-width: 70px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }

    .hItem{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height: 64px;
    }

    .hTop{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.15;
    }
    .hText{
      margin-top: 6px;
      font-weight: 1000;
      letter-spacing:.02em;
      line-height: 1.15;
    }

    /* profile view */
    .profileView{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(180,120,255,.55);
      background: rgba(255,255,255,.03);
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }
    .profileTitle{
      font-weight: 1000;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .profileText{
      margin-top: 10px;
      white-space: pre-line;
      line-height: 1.35;
      color: rgba(255,245,240,.92);
      font-size: 13px;
    }

    /* Change password block */
    .pwBox{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .pwTitle{
      font-size: 12px;
      color: rgba(255,255,255,.86);
      font-weight: 1000;
      letter-spacing:.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pwGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .pwRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,14,26,.78);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: .18s opacity, .18s transform;
      z-index: 50;
      user-select:none;
      max-width: calc(100vw - 24px);
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* ===== FOOTER LOGO (hover smoke) ===== */
    .shellFooter{
      margin-top: 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 10px 0 0;
    }
    .logoOrb{
      width: 74px;
      height: 74px;
      border-radius: 999px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 2px solid rgba(180,120,255,.38);
      background: rgba(0,0,0,.18);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 22px rgba(90,140,255,.10),
        0 0 30px rgba(180,120,255,.10);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: .18s transform, .18s box-shadow, .18s border-color, .18s filter;
    }
    .logoOrb img{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      position:relative;
      z-index:2;
      filter: saturate(1.05);
    }

    /* –¥—ã–º + –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
    .logoOrb:before,
    .logoOrb:after{
      content:"";
      position:absolute;
      inset:-40%;
      pointer-events:none;
      opacity: 0;
      transition: .18s opacity;
      z-index:1;
      filter: blur(14px);
    }
    .logoOrb:before{
      background:
        radial-gradient(circle at 35% 35%, rgba(80,180,255,.28), transparent 58%),
        radial-gradient(circle at 70% 60%, rgba(70,220,200,.18), transparent 62%),
        radial-gradient(circle at 40% 80%, rgba(120,160,255,.18), transparent 60%);
    }
    .logoOrb:after{
      background:
        radial-gradient(circle at 30% 70%, rgba(80,180,255,.22), transparent 62%),
        radial-gradient(circle at 70% 30%, rgba(120,160,255,.20), transparent 60%),
        radial-gradient(circle at 50% 50%, rgba(70,220,200,.16), transparent 60%);
      mix-blend-mode: screen;
    }

    @keyframes logoSmoke{
      0%   { transform: translate(-2%, 2%) rotate(0deg) scale(1.05); }
      50%  { transform: translate(3%, -3%) rotate(1.2deg) scale(1.12); }
      100% { transform: translate(-2%, 2%) rotate(0deg) scale(1.05); }
    }

    .logoOrb:hover{
      border-color: rgba(70,220,200,.70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.08) inset,
        0 0 28px rgba(80,180,255,.20),
        0 0 46px rgba(70,220,200,.14),
        0 26px 70px rgba(0,0,0,.38);
      filter: saturate(1.10) brightness(1.05);
      transform: translateY(-1px);
    }
    .logoOrb:hover:before,
    .logoOrb:hover:after{
      opacity: 1;
      animation: logoSmoke 2.8s ease-in-out infinite;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .sideGrid{ grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
      .pwRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="bgRoot" id="bgRoot">
    <div class="bgLayer" id="bgA"></div>
    <div class="bgLayer alt" id="bgB"></div>
    <div class="smoke"></div>
    <div class="bgTint"></div>
  </div>

  <div class="onlinePill" title="–û–Ω–ª–∞–π–Ω" id="onlinePill">‚Äî</div>

  <!-- AUTH -->
  <div class="authWrap" id="authWrap">
    <div class="card">
      <div class="title">GAME AUTH</div>
      <div class="sub" id="msg"></div>

      <div class="tabs" id="tabs">
        <button class="tab active" id="tLogin" type="button">–í—Ö–æ–¥</button>
        <button class="tab" id="tReg" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div class="form" id="loginForm">
        <input class="field" id="loginL" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username" />
        <input class="field" id="passL" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password" />
        <button class="btn" id="loginBtn" type="button">–í–æ–π—Ç–∏</button>
      </div>

      <div class="form" id="regForm" style="display:none;">
        <div class="row">
          <input class="field" id="loginR" placeholder="–õ–æ–≥–∏–Ω (–ª–∞—Ç/—Ü–∏—Ñ—Ä—ã/_)" autocomplete="username" />
          <input class="field" id="nickR" placeholder="–ù–∏–∫ (–º–æ–∂–Ω–æ —Ä—É—Å—Å–∫–∏–π)" />
        </div>
        <input class="field" id="passR" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6)" type="password" autocomplete="new-password" />

        <div class="fileRow">
          <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          <button class="btn2" id="pickAvatar" type="button">–ê–≤–∞—Ç–∞—Ä</button>
          <div class="fileName" id="avatarName">‚Äî</div>
        </div>

        <div class="avatarPreview">
          <div class="bubble">
            <img id="avatarPreviewImg" alt="avatar preview"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.55' font-family='Arial'%3E%2B%3C/text%3E%3C/svg%3E" />
          </div>
          <div class="txt" id="avatarPreviewTxt">–í—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –º—ã –µ–≥–æ —Å–æ–∂–º—ë–º –¥–æ –Ω–µ–±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞</div>
        </div>

        <button class="btn" id="regBtn" type="button">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <div class="hint">–õ–æ–≥–∏–Ω –∏ –Ω–∏–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã.</div>
      </div>
    </div>
  </div>

  <!-- SHELL -->
  <div class="shell" id="shell">
    <div class="layout">
      <div class="panel">
        <div class="sidebar">

          <div class="profileBox">
            <div class="ava" id="shellAvaBox" title="–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">
              <img id="shellAvatar" alt="avatar"
                   src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E" />
            </div>
            <div>
              <div class="pNick" id="shellNick">‚Äî</div>
              <div class="pLogin" id="shellLogin">‚Äî</div>
            </div>
          </div>

          <input id="avatarChangeFile" type="file" accept="image/*" style="display:none;" />

          <div class="sideGrid">
            <button class="sideBtn hot" id="btnBonus" type="button">–ë–æ–Ω—É—Å</button>
            <button class="sideBtn" id="btnRoulette" type="button">–†—É–ª–µ—Ç–∫–∞</button>
            <button class="sideBtn" id="btnChance" type="button">–®–∞–Ω—Å</button>
            <button class="sideBtn" id="btnProfile" type="button">–ü—Ä–æ—Ñ–∏–ª—å</button>
          </div>

          <div class="balanceBox">
            <div class="balanceTitle">–ë–∞–ª–∞–Ω—Å</div>
            <div class="balanceValue" id="balanceValue">$0</div>
          </div>

          <div class="sideActions">
            <button class="miniBtn" id="clearHistoryBtn" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="hint" style="padding:0 6px;">
            –ò—Å—Ç–æ—Ä–∏—è —Å–ø—Ä–∞–≤–∞: —Å–≤–µ—Ä—Ö—É —Å–≤–µ–∂–µ–µ, —Å–Ω–∏–∑—É —Å—Ç–∞—Ä–æ–µ (–¥–æ 10 –¥–µ–π—Å—Ç–≤–∏–π).
          </div>

          <div class="sidebarBottom">
            <button class="miniBtn" id="logoutBtn" type="button">–í—ã–π—Ç–∏</button>
          </div>

        </div>
      </div>

      <div class="panel">
        <div class="main">
          <div class="topRow">
            <div class="navRow">
              <button class="navBtn active" id="btnHome" type="button">–ì–ª–∞–≤–Ω–∞—è</button>
              <button class="navBtn market" id="btnMarket" type="button">–†—ã–Ω–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</button>
              <button class="navBtn" id="btnMyItems" type="button">–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
              <button class="navBtn" id="btnGames" type="button">–ò–≥—Ä—ã</button>
            </div>
          </div>

          <!-- HOME -->
          <div id="viewHome">
            <div class="home">
              <div class="homeTitle">
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
                <span style="color: rgba(255,255,255,.70); font-size:11px; letter-spacing:.10em; text-transform:uppercase;">
                  –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </span>
              </div>
              <div class="homeHello" id="homeHello">‚Äî</div>

              <div class="homeCards">
                <div class="homeCard primary" id="homeCardBonus" role="button" tabindex="0">
                  <div class="left">
                    <div class="kicker">–ë–æ–Ω—É—Å</div>
                    <div class="desc">–ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –±–æ–Ω—É—Å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
                  </div>
                  <div class="pill">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>

                <div class="homeCard" id="homeCardRoulette" role="button" tabindex="0">
                  <div class="left">
                    <div class="kicker">–†—É–ª–µ—Ç–∫–∞</div>
                    <div class="desc">–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –¥–µ–º–æ-—Ä—É–ª–µ—Ç–∫—É –∏ –∑–∞–ø–∏—Å–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</div>
                  </div>
                  <div class="pill">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>

                <div class="homeCard" id="homeCardProfile" role="button" tabindex="0">
                  <div class="left">
                    <div class="kicker">–ü—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="desc">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å + —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
                  </div>
                  <div class="pill">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>
              </div>
            </div>
          </div>

          <!-- HISTORY -->
          <div id="viewHistory" style="display:none;">
            <div class="history">
              <div class="historyGrid" id="historyGrid"></div>
            </div>
          </div>

          <!-- PROFILE -->
          <div id="viewProfile" style="display:none;">
            <div class="profileView">
              <div class="profileTitle">
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                <button class="btn2" id="closeProfileBtn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>

              <div class="profileText" id="profileText"></div>

              <div class="pwBox">
                <div class="pwTitle">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</div>

                <div class="pwGrid">
                  <div class="pwRow">
                    <input class="field" id="oldPass" type="password" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" autocomplete="current-password" />
                    <input class="field" id="newPass" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6)" autocomplete="new-password" />
                  </div>
                  <button class="btn" id="changePassBtn" type="button">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                  <div class="hint" id="pwHint">–°–æ–≤–µ—Ç: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä–æ–ª—å.</div>
                </div>
              </div>

            </div>
          </div>

          <!-- FOOTER LOGO -->
          <div class="shellFooter">
            <div class="logoOrb" id="logoOrb" title="WORLD_SCRIPT">
              <img src="IconWorld.png" alt="WORLD_SCRIPT logo">
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // ======================
    // Supabase
    // ======================
    var SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    function $(id){ return document.getElementById(id); }

    var authWrap = $("authWrap");
    var shell = $("shell");
    var msg = $("msg");

    var tLogin = $("tLogin"), tReg = $("tReg");
    var loginForm = $("loginForm"), regForm = $("regForm");

    var loginL = $("loginL"), passL = $("passL"), loginBtn = $("loginBtn");
    var loginR = $("loginR"), nickR = $("nickR"), passR = $("passR"), regBtn = $("regBtn");

    var avatarFile = $("avatarFile"), pickAvatar = $("pickAvatar"), avatarName = $("avatarName");
    var avatarPreviewImg = $("avatarPreviewImg");
    var avatarPreviewTxt = $("avatarPreviewTxt");

    var shellAvaBox = $("shellAvaBox");
    var shellAvatar = $("shellAvatar"), shellNick = $("shellNick"), shellLogin = $("shellLogin");
    var avatarChangeFile = $("avatarChangeFile");

    var btnBonus = $("btnBonus");
    var btnRoulette = $("btnRoulette");
    var btnChance = $("btnChance");
    var btnProfile = $("btnProfile");

    var logoutBtn = $("logoutBtn");
    var clearHistoryBtn = $("clearHistoryBtn");

    var btnHome = $("btnHome");
    var btnMarket = $("btnMarket"), btnMyItems = $("btnMyItems"), btnGames = $("btnGames");
    var historyGrid = $("historyGrid");

    var onlinePill = $("onlinePill");
    var toast = $("toast");

    var profileText = $("profileText");
    var viewHome = $("viewHome");
    var viewHistory = $("viewHistory");
    var viewProfile = $("viewProfile");
    var balanceValue = $("balanceValue");

    var homeHello = $("homeHello");
    var homeCardBonus = $("homeCardBonus");
    var homeCardRoulette = $("homeCardRoulette");
    var homeCardProfile = $("homeCardProfile");

    var closeProfileBtn = $("closeProfileBtn");
    var oldPass = $("oldPass"), newPass = $("newPass"), changePassBtn = $("changePassBtn");
    var pwHint = $("pwHint");

    function setMsg(text){ msg.textContent = text || ""; }

    function toastShow(text){
      toast.textContent = text || "";
      toast.classList.add("show");
      clearTimeout(toast.__t);
      toast.__t = setTimeout(function(){ toast.classList.remove("show"); }, 1400);
    }

    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active"); tReg.classList.remove("active");
        loginForm.style.display = "flex"; regForm.style.display = "none";
      } else {
        tReg.classList.add("active"); tLogin.classList.remove("active");
        loginForm.style.display = "none"; regForm.style.display = "flex";
      }
    }

    function validLogin(login){
      return /^[a-zA-Z0-9_]{3,20}$/.test(login);
    }

    // ===== –∫–Ω–æ–ø–∫–∞ –≤ loading =====
    function setBtnLoading(btn, loadingText, isLoading){
      if (!btn) return;
      if (!btn.__orig) btn.__orig = btn.textContent;
      if (isLoading){
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span><span>' + (loadingText || "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶") + '</span>';
      } else {
        btn.disabled = false;
        btn.textContent = btn.__orig;
      }
    }

    // ======================
    // Session
    // ======================
    function saveSession(user){
      localStorage.setItem("game_user", JSON.stringify({
        id: user.id,
        login: user.login,
        nick: user.nick,
        avatar_url: user.avatar_url || null
      }));
    }
    function loadSession(){
      try{ return JSON.parse(localStorage.getItem("game_user") || "null"); }
      catch(e){ return null; }
    }
    function clearSession(){
      localStorage.removeItem("game_user");
    }

    // ======================
    // –ò—Å—Ç–æ—Ä–∏—è (local)
    // ======================
    var HISTORY_MAX = 10;

    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem("game_history") || "[]"); }
      catch(e){ return []; }
    }
    function saveHistory(arr){
      localStorage.setItem("game_history", JSON.stringify(arr || []));
    }

    var currentUser = null;

    function addHistoryItem(text){
      var arr = loadHistory();
      var actor = currentUser ? {
        login: currentUser.login || "‚Äî",
        avatar_url: currentUser.avatar_url || null
      } : { login: "‚Äî", avatar_url: null };

      arr.unshift({
        at: new Date().toISOString(),
        text: text,
        actor: actor
      });

      if (arr.length > HISTORY_MAX) arr = arr.slice(0, HISTORY_MAX);
      saveHistory(arr);
      renderHistory();
    }

    function fmtTime(iso){
      try{
        var d = new Date(iso);
        var hh = String(d.getHours()).padStart(2,"0");
        var mm = String(d.getMinutes()).padStart(2,"0");
        var ss = String(d.getSeconds()).padStart(2,"0");
        return hh+":"+mm+":"+ss;
      }catch(_){
        return "";
      }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(c){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" })[c];
      });
    }

    function renderHistory(){
      var arr = loadHistory();
      historyGrid.innerHTML = "";

      if (!arr.length){
        var r = document.createElement("div");
        r.className = "hRow";
        r.innerHTML =
          '<div class="hLeft">' +
            '<div class="hDot"></div>' +
            '<div class="hLogin">‚Äî</div>' +
          '</div>' +
          '<div class="hItem">' +
            '<div class="hTop"><span>–ò—Å—Ç–æ—Ä–∏—è</span><span>‚Äî</span></div>' +
            '<div class="hText">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚Äú–†—É–ª–µ—Ç–∫–∞‚Äù –∏–ª–∏ ‚Äú–ë–æ–Ω—É—Å‚Äù.</div>' +
          '</div>';
        historyGrid.appendChild(r);
        return;
      }

      for (var i=0;i<arr.length;i++){
        var it = arr[i] || {};
        var actor = it.actor || {};
        var aLogin = actor.login || "‚Äî";
        var aAva = actor.avatar_url || null;

        var row = document.createElement("div");
        row.className = "hRow";

        var left =
          '<div class="hLeft">' +
            '<div class="hDot">' + (aAva ? ('<img alt="a" src="'+escapeHtml(aAva)+'" />') : '') + '</div>' +
            '<div class="hLogin">' + escapeHtml(aLogin) + '</div>' +
          '</div>';

        var right =
          '<div class="hItem">' +
            '<div class="hTop"><span>–î–µ–π—Å—Ç–≤–∏–µ</span><span>'+fmtTime(it.at)+'</span></div>' +
            '<div class="hText">'+escapeHtml(it.text)+'</div>' +
          '</div>';

        row.innerHTML = left + right;
        historyGrid.appendChild(row);
      }
    }

    // ======================
    // –ü—Ä–æ—Ñ–∏–ª—å (local state) + —Ç–∞–π–º–µ—Ä—ã (–¥–µ–º–æ)
    // ======================
    function money(n){
      n = Math.floor(Number(n || 0));
      return "$" + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function fmtLeft(ms){
      ms = Math.max(0, ms|0);
      var s = Math.floor(ms/1000);
      var d = Math.floor(s/86400); s -= d*86400;
      var h = Math.floor(s/3600);  s -= h*3600;
      var m = Math.floor(s/60);    s -= m*60;
      return d+"–¥ "+h+"—á "+m+"–º–∏–Ω";
    }
    function profileKey(login){ return "profile_state_" + (login || ""); }

    function defaultProfile(){
      var now = Date.now();
      return {
        pseudo: "–ë–∞–±–∞–±—É–π",
        emodji: "–ù–µ—Ç",
        marriage: "–ù–µ—Ç",
        clan: "–ù–µ—Ç",
        autoRoulette: "–ù–µ—Ç",
        takenBonus: 0,
        frozen: 500000,

        rouletteRating: 18.9,
        rouletteRank: 6,
        rouletteRankTitle: "–ú–µ–≥–∞–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        activityRating: 6.2,
        activityPlace: 15,

        bonus: 20355,
        gameBonus: 0,
        nickText: "Shadow Smith",
        inGame: false,

        repEarned: 53002,
        repIssued: 39,
        repCashback: 11501,

        t_x2: false,
        t_eternal: false,
        t_x3_stream: false,
        t_auto: false,

        lockTakeBonusUntil: now + (2*86400 + 6*3600 + 29*60) * 1000,
        chanceUntil: now + (1*86400 + 4*3600 + 11*60) * 1000,
        bonusResetUntil: now + (6*86400 + 7*3600 + 29*60) * 1000,
        bonusUntil: now + (5*3600) * 1000,
        rouletteUntil: now + (1*86400) * 1000,

        bonusTimeMs: (10*3600 + 36*60) * 1000
      };
    }

    function loadProfileState(user){
      try{
        var k = profileKey(user.login);
        var raw = localStorage.getItem(k);
        if (!raw) return defaultProfile();
        var st = JSON.parse(raw);
        if (!st || typeof st !== "object") return defaultProfile();
        return st;
      }catch(e){
        return defaultProfile();
      }
    }
    function saveProfileState(user, st){
      try{
        localStorage.setItem(profileKey(user.login), JSON.stringify(st));
      }catch(e){}
    }

    var profileState = null;
    var profileTimer = null;

    function updateBalanceUI(){
      var bal = 0;
      if (profileState){
        bal = (profileState.bonus || 0) + (profileState.gameBonus || 0);
      }
      balanceValue.textContent = money(bal);
    }

    function renderProfile(){
      if (!currentUser || !profileState) return;

      var now = Date.now();
      var lockLeft = fmtLeft(profileState.lockTakeBonusUntil - now);

      var txt =
`üÜî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.login}:

‚Ñπ –†–µ–π—Ç–∏–Ω–≥ —Ä—É–ª–µ—Ç–∫–∏: ${profileState.rouletteRating.toFixed(1)}, —Ä–∞–Ω–≥ ¬´${profileState.rouletteRank}¬ª: ${profileState.rouletteRankTitle} (–ø–æ–¥—Ä–æ–±–Ω–µ–µ: ¬´–†—É–ª–µ—Ç–∫–∞ –∏–Ω—Ñ–æ¬ª)
‚§¥ –†–µ–π—Ç–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: ${profileState.activityRating.toFixed(1)} (–ø–æ–¥—Ä–æ–±–Ω–µ–µ: ¬´–†–µ–π—Ç–∏–Ω–≥¬ª)
–ù–∞ ${profileState.activityPlace} –º–µ—Å—Ç–µ –≤ —Ç–æ–ø–µ –∞–∫—Ç–∏–≤–∞!

üÖ± –ë–æ–Ω—É—Å: ${money(profileState.bonus)}
‚õè –ë–æ–Ω—É—Å —Å –∏–≥—Ä—ã: ${money(profileState.gameBonus)}
üîó –ù–∏–∫: ${profileState.nickText} (${profileState.inGame ? "–≤ –∏–≥—Ä–µ" : "–Ω–µ –≤ –∏–≥—Ä–µ"})
üî∏ –ù–µ–ª—å–∑—è –∑–∞–±–∏—Ä–∞—Ç—å –±–æ–Ω—É—Å ${lockLeft}

üòè –ö—ç—à–±–µ–∫ –†–µ–ø—É—Ç–∞—Ü–∏–∏ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ: ¬´–†–µ–ø—É—Ç–∞—Ü–∏—è¬ª)
‚Äî –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${money(profileState.repEarned)}
‚Äî –í—ã–¥–∞–Ω–æ: ${profileState.repIssued} —à—Ç
‚Äî –ö—ç—à–±–µ–∫: ${money(profileState.repCashback)}

üîù –¢–∞—Ä–∏—Ñ—ã (–ø–æ–¥—Ä–æ–±–Ω–µ–µ: ¬´–¢–∞—Ä–∏—Ñ –∏–Ω—Ñ–æ¬ª):
${profileState.t_x2 ? "‚úÖ" : "‚ùå"} –•2 –±–æ–Ω—É—Å—ã —Å 12:00 –¥–æ 18:00 
${profileState.t_eternal ? "‚úÖ" : "‚ùå"} –í–µ—á–Ω—ã–π –†–∞–Ω–≥ / –ü—Å–µ–≤–¥ / –≠–º–æ–¥–∑–∏
${profileState.t_x3_stream ? "‚úÖ" : "‚ùå"} –•3 –≤ –∑–æ–Ω–µ —Å—Ç—Ä–∏–º–∞ –±–æ—Ç–∞ 
${profileState.t_auto ? "‚úÖ" : "‚ùå"} –ê–≤—Ç–æ—Ä—É–ª–µ—Ç–∫–∞ 

‚è≤ –í—Ä–µ–º—è –¥–æ:
¬ª –®–∞–Ω—Å–∞: ${fmtLeft(profileState.chanceUntil - now)}
¬ª –û–±–Ω—É–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–∞: ${fmtLeft(profileState.bonusResetUntil - now)}
¬ª –ë–æ–Ω—É—Å–∞: ${fmtLeft(profileState.bonusUntil - now)}
¬ª –†—É–ª–µ—Ç–∫–∏: ${fmtLeft(profileState.rouletteUntil - now)}

üë´ –ë—Ä–∞–∫: ${profileState.marriage}
üÜë –ö–ª–∞–Ω: ${profileState.clan}

‚ìÇ EMODJI: ${profileState.emodji}
üÄÑ –ü—Å–µ–≤–¥–æ–Ω–∏–º: ${profileState.pseudo}
üîÅ –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä. —Ä—É–ª–µ—Ç–∫–∏ –≤ –∑–∞–ø–∞—Å–µ: ${profileState.autoRoulette}
üìÇ –ó–∞–±—Ä–∞–Ω–æ –±–æ–Ω—É—Å–∞: ${money(profileState.takenBonus)}
‚ùÑ –ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ: ${money(profileState.frozen)}
‚åõ –ë–æ–Ω—É—Å–Ω–æ–µ –≤—Ä–µ–º—è: ${fmtLeft(profileState.bonusTimeMs)}`;

      profileText.textContent = txt;
      updateBalanceUI();
    }

    function showView(name){
      if (name === "profile"){
        viewHistory.style.display = "none";
        viewProfile.style.display = "block";
        renderProfile();
      } else {
        viewProfile.style.display = "none";
        viewHistory.style.display = "block";
      }
    }

    function startProfileTicker(){
      if (profileTimer) clearInterval(profileTimer);
      profileTimer = setInterval(function(){
        if (profileState && profileState.bonusTimeMs > 0){
          profileState.bonusTimeMs = Math.max(0, profileState.bonusTimeMs - 1000);
          if (currentUser) saveProfileState(currentUser, profileState);
        }
        if (viewProfile.style.display !== "none") renderProfile();
        else updateBalanceUI();
      }, 1000);
    }

    // ======================
    // –í–ê–ñ–ù–û–ï: –ê–í–ê–¢–ê–†–´ –í BASE64 (–°–ò–õ–¨–ù–û –°–ñ–ò–ú–ê–ï–ú)
    // - —Ä–µ—Å–∞–π–∑ –¥–æ 160x160
    // - —Ñ–æ—Ä–º–∞—Ç webp –µ—Å–ª–∏ –º–æ–∂–Ω–æ, –∏–Ω–∞—á–µ jpeg
    // - quality –ø–æ–Ω–∏–∂–∞–µ–º —Ü–∏–∫–ª–æ–º –ø–æ–∫–∞ –Ω–µ —É–ª–æ–∂–∏–º—Å—è –≤ KB
    // ======================
    function approxBytesFromDataURL(dataUrl){
      // –≥—Ä—É–±–æ: base64 –¥–ª–∏–Ω–∞ * 3/4
      return Math.floor(String(dataUrl || "").length * 0.75);
    }

    function canvasToDataURLSmart(canvas, mime, quality){
      try{
        var out = canvas.toDataURL(mime, quality);
        if (out && out.indexOf("data:image") === 0) return out;
      }catch(e){}
      return null;
    }

    async function fileToTinyAvatarDataURL(file, opts){
      opts = opts || {};
      var maxSide = opts.maxSide ?? 160;      // –º–µ–Ω—å—à–µ = –º–µ–Ω—å—à–µ –≤–µ—Å
      var maxOutKB = opts.maxOutKB ?? 60;     // —Ü–µ–ª—å: –¥–µ—Å—è—Ç–∫–∏ KB
      var startQ = opts.startQ ?? 0.55;       // –∫–∞—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ä—Ç
      var minQ = opts.minQ ?? 0.25;           // –º–∏–Ω–∏–º—É–º
      var step = opts.step ?? 0.06;           // —à–∞–≥
      var bg = opts.bg ?? "#10111a";
      var maxInputMB = opts.maxInputMB ?? 6; // –∏—Å—Ö–æ–¥–Ω–∏–∫ –æ–≥—Ä–∞–Ω–∏—á–∏–º

      if (!file) return null;
      if (!file.type || file.type.indexOf("image/") !== 0) {
        throw new Error("–ù—É–∂–µ–Ω —Ñ–∞–π–ª-–∫–∞—Ä—Ç–∏–Ω–∫–∞ (image/*)");
      }
      if (file.size > maxInputMB * 1024 * 1024) {
        throw new Error("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º " + maxInputMB + "MB");
      }

      var dataUrl = await new Promise(function(resolve, reject){
        var fr = new FileReader();
        fr.onerror = function(){ reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª")); };
        fr.onload = function(){ resolve(String(fr.result || "")); };
        fr.readAsDataURL(file);
      });

      var img = await new Promise(function(resolve, reject){
        var im = new Image();
        im.onload = function(){ resolve(im); };
        im.onerror = function(){ reject(new Error("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å")); };
        im.src = dataUrl;
      });

      var w = img.naturalWidth || img.width;
      var h = img.naturalHeight || img.height;

      var scale = Math.min(1, maxSide / Math.max(w, h));
      var nw = Math.max(1, Math.round(w * scale));
      var nh = Math.max(1, Math.round(h * scale));

      var canvas = document.createElement("canvas");
      canvas.width = maxSide;
      canvas.height = maxSide;
      var ctx = canvas.getContext("2d", { alpha: true });

      // —Ñ–æ–Ω, —á—Ç–æ–±—ã –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–µ –ø–æ—Ä—Ç–∏–ª–∞ jpeg/webp
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, maxSide, maxSide);

      var dx = Math.floor((maxSide - nw) / 2);
      var dy = Math.floor((maxSide - nh) / 2);
      ctx.drawImage(img, 0, 0, w, h, dx, dy, nw, nh);

      // –ø—Ä–æ–±—É–µ–º webp, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –∏–Ω–∞—á–µ jpeg
      var supportsWebp = false;
      try{
        var test = canvas.toDataURL("image/webp", 0.5);
        supportsWebp = !!test && test.indexOf("data:image/webp") === 0;
      }catch(e){ supportsWebp = false; }

      var mime = supportsWebp ? "image/webp" : "image/jpeg";

      // –∫–∞—á–µ—Å—Ç–≤–æ —É–º–µ–Ω—å—à–∞–µ–º –ø–æ–∫–∞ –Ω–µ —É–ª–æ–∂–∏–º—Å—è
      var q = startQ;
      var best = null;

      while (q >= minQ){
        var out = canvasToDataURLSmart(canvas, mime, q);
        if (!out) break;

        best = out;
        var bytes = approxBytesFromDataURL(out);
        if (bytes <= maxOutKB * 1024) break;

        q = +(q - step).toFixed(3);
      }

      if (!best) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä");
      return best;
    }

    // ======================
    // Supabase init
    // ======================
    if (!window.supabase || !window.supabase.createClient){
      setMsg("Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN).");
      return;
    }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======================
    // –ü–∞—Ä–æ–ª—å: SHA-256
    // ======================
    async function sha256(text){
      var enc = new TextEncoder().encode(text);
      var buf = await crypto.subtle.digest("SHA-256", enc);
      var arr = Array.from(new Uint8Array(buf));
      return arr.map(function(b){ return b.toString(16).padStart(2,"0"); }).join("");
    }

    // ======================
    // DB helpers
    // ======================
    async function getUserByLogin(loginLower){
      var res = await supabase.from("game_users")
        .select("id,login,nick,pass_hash,avatar_url")
        .eq("login", loginLower)
        .maybeSingle();
      if (res.error) throw res.error;
      return res.data || null;
    }

    async function existsByField(field, value){
      var q = supabase.from("game_users").select("id").limit(1);
      if (field === "login") q = q.eq("login", value);
      else q = q.ilike("nick", value);
      var res = await q;
      if (res.error) throw res.error;
      return res.data && res.data.length > 0;
    }

    // ======================
    // Online presence (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    // ======================
    var onlineTimer = null;

    async function heartbeatOnline(user){
      try{
        await supabase.from("online_presence").upsert({
          user_id: user.id,
          login: user.login,
          nick: user.nick,
          last_seen: new Date().toISOString()
        });
      }catch(e){}
    }

    async function refreshOnlineCount(){
      try{
        var since = new Date(Date.now() - 60*1000).toISOString();
        var res = await supabase.from("online_presence")
          .select("user_id", { count: "exact", head: true })
          .gte("last_seen", since);
        if (res.error) throw res.error;
        onlinePill.textContent = String(res.count || 0);
      }catch(e){
        onlinePill.textContent = "‚Äî";
      }
    }

    function startOnline(user){
      if (onlineTimer) clearInterval(onlineTimer);
      heartbeatOnline(user);
      refreshOnlineCount();
      onlineTimer = setInterval(function(){
        heartbeatOnline(user);
        refreshOnlineCount();
      }, 15000);
    }

    // ======================
    // UI switch
    // ======================
    function showShell(user){
      authWrap.style.display = "none";
      shell.style.display = "block";

      shellNick.textContent = user.nick || "‚Äî";
      shellLogin.textContent = user.login ? ("@" + user.login) : "‚Äî";

      if (user.avatar_url) shellAvatar.src = user.avatar_url;

      currentUser = user;
      profileState = loadProfileState(user);
      updateBalanceUI();
      startProfileTicker();

      renderHistory();
      startOnline(user);
      showView("history");
    }

    function showAuth(){
      shell.style.display = "none";
      authWrap.style.display = "flex";
      showTab("login");
      setMsg("");
      onlinePill.textContent = "‚Äî";

      if (onlineTimer) clearInterval(onlineTimer);
      onlineTimer = null;

      currentUser = null;
      profileState = null;
      if (profileTimer) clearInterval(profileTimer);
      profileTimer = null;
    }

    // ======================
    // Events (auth)
    // ======================
    tLogin.onclick = function(){ showTab("login"); };
    tReg.onclick = function(){ showTab("reg"); };

    // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä (—É–∂–µ —Å–∂–∞—Ç—ã–π dataURL)
    var regAvatarDataUrl = null;

    pickAvatar.onclick = function(){ avatarFile.click(); };
    avatarFile.onchange = async function(){
      setMsg("");
      var f = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;
      avatarName.textContent = f ? f.name : "‚Äî";

      if (!f){
        regAvatarDataUrl = null;
        avatarPreviewTxt.textContent = "–í—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –º—ã –µ–≥–æ —Å–æ–∂–º—ë–º –¥–æ –Ω–µ–±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞";
        return;
      }

      try{
        avatarPreviewTxt.textContent = "–°–∂–∏–º–∞—é –∞–≤–∞—Ç–∞—Ä‚Ä¶";
        regAvatarDataUrl = await fileToTinyAvatarDataURL(f, {
          maxSide: 160,
          maxOutKB: 60,   // –ø—Ä—è–º ‚Äú–∫–∏–ª–ª–æ–±–∏—Ç—ã/–¥–µ—Å—è—Ç–∫–∏ KB‚Äù
          startQ: 0.55,
          minQ: 0.25,
          step: 0.06
        });

        avatarPreviewImg.src = regAvatarDataUrl;
        var kb = Math.round(approxBytesFromDataURL(regAvatarDataUrl) / 1024);
        avatarPreviewTxt.textContent = "–ì–æ—Ç–æ–≤–æ: ~" + kb + " KB (–∫–∞—á–µ—Å—Ç–≤–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–Ω–∏–∂–µ–Ω–æ)";
      }catch(e){
        regAvatarDataUrl = null;
        avatarPreviewTxt.textContent = "–û—à–∏–±–∫–∞ —Å –∞–≤–∞—Ç–∞—Ä–æ–º";
        setMsg("–ê–≤–∞—Ç–∞—Ä –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è: " + (e && e.message ? e.message : String(e)));
      }
    };

    loginBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginL.value || "").trim().toLowerCase();
        var pass = passL.value || "";
        if (!login || !pass){ setMsg("–í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å"); return; }

        var user = await getUserByLogin(login);
        if (!user){ setMsg("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"); return; }

        var hash = await sha256(pass);
        if (hash !== user.pass_hash){ setMsg("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"); return; }

        var sessionUser = { id:user.id, login:user.login, nick:user.nick, avatar_url:user.avatar_url };
        saveSession(sessionUser);
        showShell(sessionUser);
        toastShow("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + user.nick + "!");
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    regBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginR.value || "").trim().toLowerCase();
        var nick = (nickR.value || "").trim();
        var pass = passR.value || "";

        if (!login || !nick || !pass){ setMsg("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è"); return; }
        if (!validLogin(login)){ setMsg("–õ–æ–≥–∏–Ω: 3‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_"); return; }
        if (pass.length < 6){ setMsg("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"); return; }

        if (await existsByField("login", login)){ setMsg("–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç"); return; }
        if (await existsByField("nick", nick)){ setMsg("–¢–∞–∫–æ–π –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç"); return; }

        var hash = await sha256(pass);

        // avatar_url: base64 dataURL (—É–∂–µ —Å–∂–∞—Ç—ã–π)
        var avatarUrl = regAvatarDataUrl || null;

        var ins = await supabase.from("game_users").insert({
          login: login,
          nick: nick,
          pass_hash: hash,
          avatar_url: avatarUrl
        }).select("id,login,nick,avatar_url").single();

        if (ins.error){
          console.error(ins.error);
          setMsg(ins.error.message || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
          return;
        }

        var u = ins.data;
        saveSession(u);
        showShell(u);
        addHistoryItem("–°–æ–∑–¥–∞–Ω –∞–∫–∫–∞—É–Ω—Ç");
        toastShow("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!");
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    // ======================
    // Events (avatar change in shell) -> BASE64 UPDATE
    // ======================
    shellAvaBox.onclick = function(){
      if (!currentUser) return;
      avatarChangeFile.click();
    };

    avatarChangeFile.onchange = async function(){
      setMsg("");
      try{
        if (!currentUser) return;

        var f = (avatarChangeFile.files && avatarChangeFile.files[0]) ? avatarChangeFile.files[0] : null;
        if (!f) return;

        toastShow("–°–∂–∏–º–∞—é‚Ä¶");

        var dataUrl = await fileToTinyAvatarDataURL(f, {
          maxSide: 160,
          maxOutKB: 60,
          startQ: 0.55,
          minQ: 0.25,
          step: 0.06
        });

        toastShow("–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶");

        // (RLS —É —Ç–µ–±—è –Ω–∞ —Å–∫—Ä–∏–Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω, —Ç–∞–∫ —á—Ç–æ update –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç—å)
        var upd = await supabase.from("game_users")
          .update({ avatar_url: dataUrl })
          .eq("id", currentUser.id)
          .select("id,login,nick,avatar_url")
          .single();

        if (upd.error) throw upd.error;

        currentUser.avatar_url = upd.data.avatar_url;
        shellAvatar.src = currentUser.avatar_url;
        saveSession(currentUser);

        addHistoryItem("–°–º–µ–Ω—ë–Ω –∞–≤–∞—Ç–∞—Ä");
        toastShow("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω");
      }catch(e){
        console.error(e);
        toastShow("–û—à–∏–±–∫–∞");
        setMsg("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä: " + (e && e.message ? e.message : String(e)));
      }finally{
        avatarChangeFile.value = "";
      }
    };

    // ======================
    // Events (shell)
    // ======================
    logoutBtn.onclick = function(){
      clearSession();
      showAuth();
      toastShow("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
    };

    clearHistoryBtn.onclick = function(){
      localStorage.removeItem("game_history");
      renderHistory();
      toastShow("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞");
    };

    function demoRouletteSpin(){
      var outcomes = [
        "–í—ã–ø–∞–ª –ø—Ä–µ–¥–º–µ—Ç: Aurora Shard",
        "–í—ã–ø–∞–ª –ø—Ä–µ–¥–º–µ—Ç: Violet Coin",
        "–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ‚Ä¶ –Ω–æ —à–∞–Ω—Å —Ä–∞—Å—Ç—ë—Ç",
        "–í—ã–ø–∞–ª –ø—Ä–µ–¥–º–µ—Ç: Prism Core",
        "–ë–æ–Ω—É—Å: +1 –ø–æ–ø—ã—Ç–∫–∞ (–¥–µ–º–æ)"
      ];
      return outcomes[Math.floor(Math.random() * outcomes.length)];
    }

    btnBonus.onclick = function(){
      if (!profileState || !currentUser) return;

      var add = 250 + Math.floor(Math.random()*501);
      profileState.bonus += add;
      profileState.lockTakeBonusUntil = Math.max(profileState.lockTakeBonusUntil, Date.now() + 2*3600*1000);

      saveProfileState(currentUser, profileState);
      updateBalanceUI();
      if (viewProfile.style.display !== "none") renderProfile();

      addHistoryItem("–ë–æ–Ω—É—Å: +" + money(add));
      toastShow("–ë–æ–Ω—É—Å +" + money(add));
    };

    btnRoulette.onclick = function(){
      if (!profileState || !currentUser) return;

      var x = demoRouletteSpin();
      profileState.activityRating = Math.min(99.9, profileState.activityRating + 0.05);
      profileState.rouletteUntil = Math.max(profileState.rouletteUntil, Date.now() + 24*3600*1000);

      saveProfileState(currentUser, profileState);
      updateBalanceUI();
      if (viewProfile.style.display !== "none") renderProfile();

      showView("history");
      addHistoryItem("–†—É–ª–µ—Ç–∫–∞: " + x);
      toastShow(x);
    };

    btnChance.onclick = function(){
      if (!profileState || !currentUser) return;

      profileState.chanceUntil = Math.max(profileState.chanceUntil, Date.now() + 24*3600*1000);
      profileState.activityRating = Math.min(99.9, profileState.activityRating + 0.10);

      saveProfileState(currentUser, profileState);
      updateBalanceUI();
      if (viewProfile.style.display !== "none") renderProfile();

      showView("history");
      addHistoryItem("–®–∞–Ω—Å: –æ–±–Ω–æ–≤–ª—ë–Ω (–¥–µ–º–æ)");
      toastShow("–®–∞–Ω—Å ‚Üë");
    };

    btnProfile.onclick = function(){
      addHistoryItem("–û—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å");
      toastShow("–ü—Ä–æ—Ñ–∏–ª—å");
      showView("profile");
    };

    btnMarket.onclick = function(){ showView("history"); addHistoryItem("–û—Ç–∫—Ä—ã—Ç: –†—ã–Ω–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤"); toastShow("–†—ã–Ω–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤"); };
    btnMyItems.onclick = function(){ showView("history"); addHistoryItem("–û—Ç–∫—Ä—ã—Ç–æ: –ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã"); toastShow("–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã"); };
    btnGames.onclick = function(){ showView("history"); addHistoryItem("–û—Ç–∫—Ä—ã—Ç–æ: –ò–≥—Ä—ã"); toastShow("–ò–≥—Ä—ã"); };

    // ======================
    // init session
    // ======================
    (function(){
      var s = loadSession();
      if (s && s.login) showShell(s);
      else showAuth();
    })();

    // ======================
    // –ü–∞—Ä–∞–ª–ª–∞–∫—Å –º—ã—à—å—é (–ª–µ–≥–∫–∏–π)
    // ======================
    window.addEventListener("mousemove", function(e){
      var cx = window.innerWidth / 2;
      var cy = window.innerHeight / 2;
      var dx = (e.clientX - cx);
      var dy = (e.clientY - cy);
      document.documentElement.style.setProperty("--parX", dx.toFixed(0) + "px");
      document.documentElement.style.setProperty("--parY", dy.toFixed(0) + "px");
    }, { passive:true });

  })();
  </script>
</body>
</html>
