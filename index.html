<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Shell</title>

  <style>
    :root{
      --bg0:#050814;
      --bg1:#071024;
      --panel: rgba(10,14,26,.72);
      --panel2: rgba(8,10,18,.55);
      --line: rgba(255,255,255,.10);
      --text: rgba(240,246,255,.92);
      --muted: rgba(240,246,255,.55);

      --neon: #2bff2b;
      --neon2:#66aaff;
      --pink:#ff4fd8;

      --r1: 22px;
      --r2: 18px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background:
        radial-gradient(1100px 740px at 28% 18%, rgba(70, 120, 190, .22), transparent 60%),
        radial-gradient(880px 660px at 78% 75%, rgba(160, 70, 120, .18), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* ===== AUTH CARD ===== */
    .authWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .card{
      width: min(540px, 100%);
      border-radius: var(--r1);
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(14px);
      padding: 14px;
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 5%, rgba(43,255,43,.16), transparent 60%),
        radial-gradient(520px 240px at 90% 20%, rgba(255,79,216,.12), transparent 55%);
      pointer-events:none;
    }
    .card > *{ position:relative; z-index:1; }

    .title{
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      white-space: pre-line;
    }
    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.86);
      font-weight: 900;
      font-size: 12px;
      user-select:none;
      transition: .14s transform, .14s box-shadow, .14s border-color;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(43,255,43,.35); box-shadow: 0 0 18px rgba(43,255,43,.12); }
    .tab.active{
      border-color: rgba(43,255,43,.45);
      background: rgba(255,255,255,.07);
    }
    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }

    .btn{
      border-radius: 14px;
      border: 1px solid rgba(43,255,43,.45);
      background: linear-gradient(135deg, rgba(43,255,43,.18), rgba(102,170,255,.10));
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition: .14s transform, .14s box-shadow, .14s border-color;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 0 22px rgba(43,255,43,.20), 0 20px 55px rgba(0,0,0,.35);
      border-color: rgba(43,255,43,.75);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.35; }

    /* ===== GAME SHELL ===== */
    .shell{
      display:none;
      min-height:100vh;
      padding: 18px;
      position:relative;
    }

    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      align-items:start;
    }

    .panel{
      border-radius: 24px;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      box-shadow: 0 26px 70px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(420px 220px at 20% 8%, rgba(43,255,43,.18), transparent 60%),
        radial-gradient(420px 220px at 90% 25%, rgba(255,79,216,.10), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .panel > *{ position:relative; z-index:1; }

    /* Left sidebar */
    .sidebar{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .profileBox{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }

    .ava{
      width:64px;height:64px;border-radius:999px;
      border: 2px solid rgba(43,255,43,.55);
      box-shadow: 0 0 22px rgba(43,255,43,.18);
      overflow:hidden;
      background: rgba(0,0,0,.25);
    }
    .ava img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pNick{ font-weight:950; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pLogin{ margin-top:6px; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Рулетка + 4 кнопки справа */
    .rouletteRow{
      display:grid;
      grid-template-columns: 1fr 160px;
      gap: 12px;
      align-items:stretch;
    }

    .rouletteBtn{
      margin-top: 10px;
      height: 190px;
      border-radius: 999px;
      border: 3px solid rgba(43,255,43,.85);
      background:
        radial-gradient(circle at 30% 35%, rgba(43,255,43,.18), transparent 55%),
        radial-gradient(circle at 75% 70%, rgba(255,79,216,.10), transparent 55%),
        rgba(255,255,255,.03);
      box-shadow:
        0 0 0 6px rgba(43,255,43,.10),
        0 0 40px rgba(43,255,43,.18),
        0 24px 70px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-weight: 1000;
      transition: .16s transform, .16s box-shadow;
      position:relative;
      overflow:hidden;
    }
    .rouletteBtn:hover{
      transform: translateY(-2px) scale(1.01);
      box-shadow:
        0 0 0 6px rgba(43,255,43,.12),
        0 0 60px rgba(43,255,43,.26),
        0 30px 90px rgba(0,0,0,.45);
    }
    .rouletteBtn:active{ transform: translateY(0px) scale(.995); }

    .rouletteBtn .label{
      font-size: 13px;
      text-align:center;
      line-height:1.2;
      padding: 0 18px;
    }

    .sideGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .sideBtn{
      border-radius: 16px;
      border: 2px solid rgba(43,255,43,.55);
      background:
        radial-gradient(circle at 30% 30%, rgba(43,255,43,.18), transparent 55%),
        rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
      transition: .14s transform, .14s box-shadow, .14s border-color;
    }

    .sideBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(43,255,43,.9);
      box-shadow: 0 0 22px rgba(43,255,43,.18), 0 18px 45px rgba(0,0,0,.35);
    }
    .sideBtn:active{ transform: translateY(0px) scale(.99); }

    .sideActions{
      display:flex; gap:10px;
    }
    .miniBtn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color;
    }
    .miniBtn:hover{ transform: translateY(-1px); border-color: rgba(43,255,43,.35); box-shadow:0 0 18px rgba(43,255,43,.12); }

    /* Main */
    .main{
      padding: 14px;
      min-height: 520px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .navRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    .navBtn{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      transition:.14s transform,.14s box-shadow,.14s border-color;
      text-transform: uppercase;
      letter-spacing:.08em;
    }
    .navBtn:hover{ transform: translateY(-1px); border-color: rgba(43,255,43,.35); box-shadow:0 0 18px rgba(43,255,43,.10); }

    /* Market — выделенный */
    .navBtn.market{
      border-color: rgba(43,255,43,.65);
      background: linear-gradient(135deg, rgba(43,255,43,.22), rgba(102,170,255,.12));
      box-shadow: 0 0 22px rgba(43,255,43,.14);
      position:relative;
      overflow:hidden;
    }
    .navBtn.market:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle, rgba(43,255,43,.22), transparent 60%);
      animation: pulseGlow 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulseGlow{
      0%,100%{ opacity:.55; transform: translateX(-6px); }
      50%{ opacity:1; transform: translateX(6px); }
    }

    /* Online bubble (правый верх) */
    .onlinePill{
      border-radius: 999px;
      width: 58px;
      height: 58px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 3px solid rgba(43,255,43,.85);
      box-shadow: 0 0 26px rgba(43,255,43,.18);
      background: rgba(255,255,255,.03);
      font-weight:1000;
      font-size: 16px;
      position: fixed;
      right: 18px;
      top: 18px;
      z-index: 5;
    }

    /* ===== История: 10 строк, кружок + текст ровно ===== */
    .history{
      margin-top: 12px;
      border-radius: 22px;
      border: 3px solid rgba(43,255,43,.85);
      background: rgba(255,255,255,.02);
      min-height: 420px;
      padding: 12px;
      display:block;
    }

    .historyGrid{
      display:grid;
      grid-template-columns: 44px 1fr;
      gap: 12px;
      align-items:start;
    }

    .dots{
      width:auto;
      padding-top: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:center;
      flex:none;
    }
    .dot{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid rgba(43,255,43,.85);
      box-shadow: 0 0 18px rgba(43,255,43,.12);
      background: rgba(0,0,0,.12);
    }

    .historyList{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 0;
      max-height: 520px;
      overflow:auto;
    }

    .hItem{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 8px 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      min-height: 34px;
      display:flex;
      align-items:center;
    }
    .hTop{ display:none; }
    .hText{
      margin-top: 0;
      font-weight: 900;
      letter-spacing:.02em;
      line-height: 1.1;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,14,26,.78);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: .18s opacity, .18s transform;
      z-index: 50;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .onlinePill{ position: fixed; }
      .rouletteBtn{ height: 150px; }
      .rouletteRow{ grid-template-columns: 1fr; }
      .sideGrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>

  <!-- ONLINE -->
  <div class="onlinePill" title="Онлайн" id="onlinePill">—</div>

  <!-- AUTH -->
  <div class="authWrap" id="authWrap">
    <div class="card">
      <div class="title">GAME AUTH</div>
      <div class="sub" id="msg"></div>

      <div class="tabs" id="tabs">
        <button class="tab active" id="tLogin" type="button">Вход</button>
        <button class="tab" id="tReg" type="button">Регистрация</button>
      </div>

      <!-- LOGIN -->
      <div class="form" id="loginForm">
        <input class="field" id="loginL" placeholder="Логин" autocomplete="username" />
        <input class="field" id="passL" placeholder="Пароль" type="password" autocomplete="current-password" />
        <button class="btn" id="loginBtn" type="button">Войти</button>
      </div>

      <!-- REGISTER -->
      <div class="form" id="regForm" style="display:none;">
        <div class="row">
          <input class="field" id="loginR" placeholder="Логин (лат/цифры/_)" autocomplete="username" />
          <input class="field" id="nickR" placeholder="Ник (можно русский)" />
        </div>
        <input class="field" id="passR" placeholder="Пароль (мин. 6)" type="password" autocomplete="new-password" />

        <div class="fileRow">
          <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          <button class="btn2" id="pickAvatar" type="button">Аватар</button>
          <div class="fileName" id="avatarName">—</div>
        </div>

        <button class="btn" id="regBtn" type="button">Создать аккаунт</button>
        <div class="hint">Логин и ник должны быть уникальны.</div>
      </div>
    </div>
  </div>

  <!-- SHELL -->
  <div class="shell" id="shell">
    <div class="layout">
      <!-- LEFT -->
      <div class="panel">
        <div class="sidebar">

          <!-- 2/3/4 -->
          <div class="profileBox">
            <div class="ava"><img id="shellAvatar" alt="avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E" /></div>
            <div>
              <div class="pNick" id="shellNick">—</div>
              <div class="pLogin" id="shellLogin">—</div>
            </div>
          </div>

          <!-- 1 + новые кнопки -->
          <div class="rouletteRow">
            <div class="rouletteBtn" id="spinBtn">
              <div class="label">Прокрутить<br/>рулетку</div>
            </div>

            <div class="sideGrid">
              <button class="sideBtn" id="btnBonus" type="button">Бонус</button>
              <button class="sideBtn" id="btnRoulette" type="button">Рулетка</button>
              <button class="sideBtn" id="btnChance" type="button">Шанс</button>
              <button class="sideBtn" id="btnProfile" type="button">Профиль</button>
            </div>
          </div>

          <div class="sideActions">
            <button class="miniBtn" id="logoutBtn" type="button">Выйти</button>
            <button class="miniBtn" id="clearHistoryBtn" type="button">Очистить</button>
          </div>

          <div class="hint" style="padding:0 6px;">
            История справа: сверху свежее, снизу старое.
          </div>
        </div>
      </div>

      <!-- MAIN -->
      <div class="panel">
        <div class="main">
          <div class="topRow">
            <div class="navRow">
              <button class="navBtn market" id="btnMarket" type="button">Рынок предметов</button>
              <button class="navBtn" id="btnMyItems" type="button">Мои предметы</button>
              <button class="navBtn" id="btnGames" type="button">Игры</button>
            </div>
          </div>

          <!-- 6 -->
          <div class="history">
            <div class="historyGrid">
              <div class="dots" id="dotsCol"></div>
              <div class="historyList" id="historyList"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // === Supabase ===
    var SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    function $(id){ return document.getElementById(id); }

    var authWrap = $("authWrap");
    var shell = $("shell");
    var msg = $("msg");

    var tLogin = $("tLogin"), tReg = $("tReg");
    var loginForm = $("loginForm"), regForm = $("regForm");

    var loginL = $("loginL"), passL = $("passL"), loginBtn = $("loginBtn");
    var loginR = $("loginR"), nickR = $("nickR"), passR = $("passR"), regBtn = $("regBtn");
    var avatarFile = $("avatarFile"), pickAvatar = $("pickAvatar"), avatarName = $("avatarName");

    var shellAvatar = $("shellAvatar"), shellNick = $("shellNick"), shellLogin = $("shellLogin");
    var spinBtn = $("spinBtn");
    var logoutBtn = $("logoutBtn");
    var clearHistoryBtn = $("clearHistoryBtn");

    var btnMarket = $("btnMarket"), btnMyItems = $("btnMyItems"), btnGames = $("btnGames");
    var btnBonus = $("btnBonus"), btnRoulette = $("btnRoulette"), btnChance = $("btnChance"), btnProfile = $("btnProfile");

    var historyList = $("historyList");
    var dotsCol = $("dotsCol");

    var onlinePill = $("onlinePill");
    var toast = $("toast");

    function setMsg(text){ msg.textContent = text || ""; }

    function toastShow(text){
      toast.textContent = text || "";
      toast.classList.add("show");
      setTimeout(function(){ toast.classList.remove("show"); }, 1400);
    }

    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active"); tReg.classList.remove("active");
        loginForm.style.display = "flex"; regForm.style.display = "none";
      } else {
        tReg.classList.add("active"); tLogin.classList.remove("active");
        loginForm.style.display = "none"; regForm.style.display = "flex";
      }
    }

    function validLogin(login){
      return /^[a-zA-Z0-9_]{3,20}$/.test(login);
    }

    function saveSession(user){
      localStorage.setItem("game_user", JSON.stringify({
        id: user.id,
        login: user.login,
        nick: user.nick,
        avatar_url: user.avatar_url || null
      }));
    }
    function loadSession(){
      try{ return JSON.parse(localStorage.getItem("game_user") || "null"); }
      catch(e){ return null; }
    }
    function clearSession(){
      localStorage.removeItem("game_user");
    }

    // ===== History (local) =====
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem("game_history") || "[]"); }
      catch(e){ return []; }
    }
    function saveHistory(arr){
      localStorage.setItem("game_history", JSON.stringify(arr || []));
    }
    function addHistoryItem(text){
      var arr = loadHistory();
      arr.unshift({ at: new Date().toISOString(), text: text });
      if (arr.length > 10) arr = arr.slice(0,10);
      saveHistory(arr);
      renderHistory();
    }

    function renderHistory(){
      var arr = loadHistory();
      historyList.innerHTML = "";
      dotsCol.innerHTML = "";

      var showDots = Math.max(1, Math.min(10, arr.length));
      for (var i=0;i<showDots;i++){
        var dot = document.createElement("div");
        dot.className = "dot";
        dotsCol.appendChild(dot);
      }

      if (!arr.length){
        var empty = document.createElement("div");
        empty.className = "hItem";
        empty.innerHTML = '<div class="hText">Пока пусто. Нажми “Прокрутить рулетку”.</div>';
        historyList.appendChild(empty);
        return;
      }

      for (var k=0; k<arr.length; k++){
        var it = arr[k];
        var el = document.createElement("div");
        el.className = "hItem";
        el.innerHTML = '<div class="hText">'+escapeHtml(it.text)+'</div>';
        historyList.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(c){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" })[c];
      });
    }

    // ===== Supabase init =====
    if (!window.supabase || !window.supabase.createClient){
      setMsg("Supabase SDK не загрузился (CDN).");
      return;
    }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Password hash (SHA-256) =====
    async function sha256(text){
      var enc = new TextEncoder().encode(text);
      var buf = await crypto.subtle.digest("SHA-256", enc);
      var arr = Array.from(new Uint8Array(buf));
      return arr.map(function(b){ return b.toString(16).padStart(2,"0"); }).join("");
    }

    // ===== Avatar upload =====
    async function uploadAvatar(file){
      var ext = (file.name.split(".").pop() || "png").toLowerCase();
      var path = "public/" + Date.now() + "_" + Math.random().toString(16).slice(2) + "." + ext;

      var up = await supabase.storage.from("avatars")
        .upload(path, file, { upsert: true, contentType: file.type });

      if (up.error) throw up.error;

      var pub = supabase.storage.from("avatars").getPublicUrl(path);
      return pub && pub.data ? pub.data.publicUrl : null;
    }

    // ===== DB helpers =====
    async function getUserByLogin(loginLower){
      var res = await supabase.from("game_users")
        .select("id,login,nick,pass_hash,avatar_url")
        .eq("login", loginLower)
        .maybeSingle();
      if (res.error) throw res.error;
      return res.data || null;
    }

    async function existsByField(field, value){
      var q = supabase.from("game_users").select("id").limit(1);
      if (field === "login") q = q.eq("login", value);
      else q = q.ilike("nick", value); // case-insensitive
      var res = await q;
      if (res.error) throw res.error;
      return res.data && res.data.length > 0;
    }

    // ===== Online presence =====
    var onlineTimer = null;

    async function heartbeatOnline(user){
      try{
        await supabase.from("online_presence").upsert({
          user_id: user.id,
          login: user.login,
          nick: user.nick,
          last_seen: new Date().toISOString()
        });
      }catch(e){
        // таблицы может не быть — ок
      }
    }

    async function refreshOnlineCount(){
      try{
        var since = new Date(Date.now() - 60*1000).toISOString();
        var res = await supabase.from("online_presence")
          .select("user_id", { count: "exact", head: true })
          .gte("last_seen", since);
        if (res.error) throw res.error;
        onlinePill.textContent = String(res.count || 0);
      }catch(e){
        onlinePill.textContent = "—";
      }
    }

    function startOnline(user){
      if (onlineTimer) clearInterval(onlineTimer);
      heartbeatOnline(user);
      refreshOnlineCount();
      onlineTimer = setInterval(function(){
        heartbeatOnline(user);
        refreshOnlineCount();
      }, 15000);
    }

    // ===== UI switch =====
    function showShell(user){
      authWrap.style.display = "none";
      shell.style.display = "block";

      shellNick.textContent = user.nick || "—";
      shellLogin.textContent = user.login ? ("@" + user.login) : "—";
      if (user.avatar_url) shellAvatar.src = user.avatar_url;

      renderHistory();
      startOnline(user);
    }

    function showAuth(){
      shell.style.display = "none";
      authWrap.style.display = "flex";
      showTab("login");
      setMsg("");
      onlinePill.textContent = "—";
      if (onlineTimer) clearInterval(onlineTimer);
      onlineTimer = null;
    }

    // ===== events =====
    tLogin.onclick = function(){ showTab("login"); };
    tReg.onclick = function(){ showTab("reg"); };

    pickAvatar.onclick = function(){ avatarFile.click(); };
    avatarFile.onchange = function(){
      var f = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;
      avatarName.textContent = f ? f.name : "—";
    };

    loginBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginL.value || "").trim().toLowerCase();
        var pass = passL.value || "";
        if (!login || !pass){ setMsg("Введи логин и пароль"); return; }

        var user = await getUserByLogin(login);
        if (!user){ setMsg("Неверный логин или пароль"); return; }

        var hash = await sha256(pass);
        if (hash !== user.pass_hash){ setMsg("Неверный логин или пароль"); return; }

        var sess = { id:user.id, login:user.login, nick:user.nick, avatar_url:user.avatar_url };
        saveSession(sess);
        showShell(sess);
        toastShow("Добро пожаловать, " + user.nick + "!");
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    regBtn.onclick = async function(){
      setMsg("");
      try{
        var login = (loginR.value || "").trim().toLowerCase();
        var nick = (nickR.value || "").trim();
        var pass = passR.value || "";
        var file = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;

        if (!login || !nick || !pass){ setMsg("Заполни поля"); return; }
        if (!validLogin(login)){ setMsg("Логин: 3–20 символов, только латиница/цифры/_"); return; }
        if (pass.length < 6){ setMsg("Пароль минимум 6 символов"); return; }

        if (await existsByField("login", login)){ setMsg("Такой логин уже занят"); return; }
        if (await existsByField("nick", nick)){ setMsg("Такой ник уже занят"); return; }

        var avatarUrl = null;
        if (file){
          try{ avatarUrl = await uploadAvatar(file); }
          catch(err){ console.error(err); }
        }

        var hash = await sha256(pass);

        var ins = await supabase.from("game_users").insert({
          login: login,
          nick: nick,
          pass_hash: hash,
          avatar_url: avatarUrl
        }).select("id,login,nick,avatar_url").single();

        if (ins.error){
          console.error(ins.error);
          setMsg(ins.error.message || "Ошибка регистрации");
          return;
        }

        var u = ins.data;
        saveSession(u);
        showShell(u);
        addHistoryItem("Создан аккаунт: " + u.nick);
        toastShow("Аккаунт создан!");
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }
    };

    logoutBtn.onclick = function(){
      clearSession();
      showAuth();
      toastShow("Выход выполнен");
    };

    clearHistoryBtn.onclick = function(){
      localStorage.removeItem("game_history");
      renderHistory();
      toastShow("История очищена");
    };

    spinBtn.onclick = function(){
      var outcomes = [
        "Выпал предмет: Neon Shard",
        "Выпал предмет: Lucky Chip",
        "Ничего не выпало… но шанс растёт",
        "Выпал предмет: Emerald Core",
        "Бонус: +1 попытка (демо)"
      ];
      var x = outcomes[Math.floor(Math.random() * outcomes.length)];
      addHistoryItem("Рулетка: " + x);
      toastShow(x);
    };

    btnBonus.onclick = function(){ addHistoryItem("Открыто: Бонус"); toastShow("Бонус"); };
    btnRoulette.onclick = function(){ addHistoryItem("Открыто: Рулетка"); toastShow("Рулетка"); };
    btnChance.onclick = function(){ addHistoryItem("Открыто: Шанс"); toastShow("Шанс"); };
    btnProfile.onclick = function(){ addHistoryItem("Открыто: Профиль"); toastShow("Профиль"); };

    btnMarket.onclick = function(){ addHistoryItem("Открыт: Рынок предметов"); toastShow("Рынок предметов"); };
    btnMyItems.onclick = function(){ addHistoryItem("Открыто: Мои предметы"); toastShow("Мои предметы"); };
    btnGames.onclick = function(){ addHistoryItem("Открыто: Игры"); toastShow("Игры"); };

    // init
    (function(){
      var s = loadSession();
      if (s && s.login) showShell(s);
      else showAuth();
    })();

  })();
  </script>
</body>
</html>
