<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth + Profile (Supabase)</title>
  <style>
    :root{
      --bg0:#070a10; --bg1:#0b1020;
      --panel: rgba(14,18,28,.78);
      --line: rgba(255,255,255,.10);
      --text: rgba(232,238,250,.92);
      --muted: rgba(232,238,250,.55);
      --accent: 120 180 255;
      --r1: 22px;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      background:
        radial-gradient(1100px 740px at 28% 18%, rgba(70, 120, 190, .22), transparent 60%),
        radial-gradient(880px 660px at 78% 75%, rgba(160, 70, 120, .18), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
    }
    .card{
      width: min(560px, 100%);
      border-radius: var(--r1);
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(12px);
      padding: 14px;
    }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .title{
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      white-space: pre-line;
    }
    .tabs{ display:flex; gap:8px; margin-top: 12px; }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      cursor:pointer;
      color: rgba(255,255,255,.86);
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(var(--accent), .35);
      background: rgba(255,255,255,.07);
    }
    .form{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .field{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .field::placeholder{ color: rgba(255,255,255,.35); }
    .btn{
      border-radius: 14px;
      border: 1px solid rgba(var(--accent), .35);
      background: rgba(var(--accent), .10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn2{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .btnDanger{
      border-radius: 14px;
      border: 1px solid rgba(255,140,120,.35);
      background: rgba(255,140,120,.10);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .profile{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .avatar{
      width: 64px; height: 64px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      flex:none;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; }
    .plogin{ font-weight: 900; font-size: 14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pnick{ margin-top: 6px; font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size: 12px; color: var(--muted); line-height: 1.35; }
    .fileRow{ display:flex; gap:10px; align-items:center; }
    .fileName{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sep{ height:1px; background: rgba(255,255,255,.08); margin-top: 12px; }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">AUTH / PROFILE</div>
    <div class="sub" id="msg"></div>

    <div class="tabs" id="tabs">
      <button class="tab active" id="tLogin" type="button">Вход</button>
      <button class="tab" id="tReg" type="button">Регистрация</button>
    </div>

    <!-- LOGIN -->
    <div class="form" id="loginForm">
      <input class="field" id="emailL" placeholder="Email" autocomplete="email" />
      <input class="field" id="passL" placeholder="Пароль" type="password" autocomplete="current-password" />
      <button class="btn" id="loginBtn" type="button">Войти</button>
    </div>

    <!-- REGISTER -->
    <div class="form" id="regForm" style="display:none;">
      <div class="row">
        <input class="field" id="emailR" placeholder="Email" autocomplete="email" />
        <input class="field" id="passR" placeholder="Пароль (мин. 6)" type="password" autocomplete="new-password" />
      </div>
      <div class="row">
        <input class="field" id="loginR" placeholder="Логин (лат/цифры/_)" />
        <input class="field" id="nickR" placeholder="Ник (можно русский)" />
      </div>

      <div class="fileRow">
        <input id="avatarFile" type="file" accept="image/*" style="display:none;" />
        <button class="btn2" id="pickAvatar" type="button">Аватар</button>
        <div class="fileName" id="avatarName">—</div>
      </div>

      <button class="btn" id="regBtn" type="button">Создать аккаунт</button>
      <div class="hint">
        Если включено подтверждение email — придёт письмо. После подтверждения просто войди.
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="profileArea" style="display:none;">
      <div class="profile">
        <div class="avatar">
          <img id="avatarImg" alt="avatar"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Crect width='160' height='160' fill='%2310111a'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='56' fill='white' fill-opacity='.75' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E">
        </div>
        <div class="pmeta">
          <div class="plogin" id="pLogin">—</div>
          <div class="pnick" id="pNick">—</div>
          <div class="hint" id="pEmail">—</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="form">
        <button class="btnDanger" id="logoutBtn" type="button">Выйти</button>
      </div>
    </div>
  </div>

  <!-- Supabase SDK (надёжный CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
  (function(){
    // ====== твой Supabase ======
    var SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    function $(id){ return document.getElementById(id); }

    var msg = $("msg");
    var tabsEl = $("tabs");
    var tLogin = $("tLogin");
    var tReg = $("tReg");
    var loginForm = $("loginForm");
    var regForm = $("regForm");
    var profileArea = $("profileArea");

    var emailL = $("emailL");
    var passL = $("passL");
    var loginBtn = $("loginBtn");

    var emailR = $("emailR");
    var passR = $("passR");
    var loginR = $("loginR");
    var nickR = $("nickR");
    var avatarFile = $("avatarFile");
    var pickAvatar = $("pickAvatar");
    var avatarName = $("avatarName");
    var regBtn = $("regBtn");

    var pLogin = $("pLogin");
    var pNick = $("pNick");
    var pEmail = $("pEmail");
    var avatarImg = $("avatarImg");
    var logoutBtn = $("logoutBtn");

    function setMsg(text){ msg.textContent = text || ""; }
    function setBusy(b){
      loginBtn.disabled = b;
      regBtn.disabled = b;
      logoutBtn.disabled = b;
      pickAvatar.disabled = b;
      tLogin.disabled = b;
      tReg.disabled = b;
    }

    function showTab(which){
      if (which === "login"){
        tLogin.classList.add("active");
        tReg.classList.remove("active");
        loginForm.style.display = "flex";
        regForm.style.display = "none";
      } else {
        tReg.classList.add("active");
        tLogin.classList.remove("active");
        loginForm.style.display = "none";
        regForm.style.display = "flex";
      }
    }

    function setAuthedUI(user, profile){
      profileArea.style.display = "block";
      tabsEl.style.display = "none";
      loginForm.style.display = "none";
      regForm.style.display = "none";

      pLogin.textContent = (profile && profile.login) ? profile.login : "—";
      pNick.textContent  = (profile && profile.nick)  ? profile.nick  : "—";
      pEmail.textContent = user && user.email ? user.email : "—";
      if (profile && profile.avatar_url) avatarImg.src = profile.avatar_url;
    }

    function setGuestUI(){
      profileArea.style.display = "none";
      tabsEl.style.display = "flex";
      showTab("login");
      setMsg("");
    }

    function validLogin(login){
      return /^[a-zA-Z0-9_]{3,20}$/.test(login);
    }

    // 1) Проверяем, загрузился ли Supabase SDK
    if (!window.supabase || !window.supabase.createClient){
      setMsg("Ошибка: Supabase SDK не загрузился. Проверь интернет/блокировки CDN.");
      console.error("Supabase SDK not loaded");
      return;
    }

    // 2) Создаём клиент
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 3) Кнопки/табы — обработчики (проверка клика)
    tLogin.onclick = function(){ showTab("login"); };
    tReg.onclick = function(){ showTab("reg"); };

    pickAvatar.onclick = function(){ avatarFile.click(); };
    avatarFile.onchange = function(){
      var f = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;
      avatarName.textContent = f ? f.name : "—";
    };

    async function loadProfile(userId){
      var res = await supabase.from("profiles")
        .select("id,login,nick,avatar_url")
        .eq("id", userId)
        .maybeSingle();
      if (res.error) throw res.error;
      return res.data || null;
    }

    async function uploadAvatar(userId, file){
      // bucket: avatars (Public)
      var ext = (file.name.split(".").pop() || "png").toLowerCase();
      var path = userId + "/" + Date.now() + "." + ext;

      var up = await supabase.storage.from("avatars")
        .upload(path, file, { upsert: true, contentType: file.type });
      if (up.error) throw up.error;

      var pub = supabase.storage.from("avatars").getPublicUrl(path);
      return pub && pub.data ? pub.data.publicUrl : null;
    }

    async function ensureProfile(user){
      var existing = await loadProfile(user.id);
      if (existing) return existing;

      // берём из user_metadata или из pending_profile
      var md = user.user_metadata || {};
      var pending = null;
      try{ pending = JSON.parse(localStorage.getItem("pending_profile") || "null"); }catch(e){}

      var login = (md.login || (pending && pending.login) || "").trim();
      var nick  = (md.nick  || (pending && pending.nick)  || "").trim();
      var avatar_url = md.avatar_url || (pending && pending.avatar_url) || null;

      if (!login || !nick) throw new Error("Профиль не найден и нет данных для создания.");

      var ins = await supabase.from("profiles").insert({
        id: user.id,
        login: login,
        nick: nick,
        avatar_url: avatar_url
      });

      if (ins.error) throw ins.error;

      localStorage.removeItem("pending_profile");
      return await loadProfile(user.id);
    }

    loginBtn.onclick = async function(){
      setMsg("");
      setBusy(true);
      try{
        var email = (emailL.value || "").trim();
        var pass = passL.value || "";
        if (!email || !pass){ setMsg("Введи email и пароль"); return; }

        var res = await supabase.auth.signInWithPassword({ email: email, password: pass });
        if (res.error){ setMsg(res.error.message); return; }

        var user = res.data.user;
        var profile = await ensureProfile(user);
        setAuthedUI(user, profile);
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
        try{ await supabase.auth.signOut(); }catch(_){}
        setGuestUI();
      }finally{
        setBusy(false);
      }
    };

    regBtn.onclick = async function(){
      setMsg("");
      setBusy(true);
      try{
        var email = (emailR.value || "").trim();
        var pass = passR.value || "";
        var login = (loginR.value || "").trim();
        var nick  = (nickR.value || "").trim();
        var file = (avatarFile.files && avatarFile.files[0]) ? avatarFile.files[0] : null;

        if (!email || !pass || !login || !nick){ setMsg("Заполни все поля"); return; }
        if (pass.length < 6){ setMsg("Пароль минимум 6 символов"); return; }
        if (!validLogin(login)){ setMsg("Логин: 3–20 символов, только латиница/цифры/_"); return; }

        // сохраняем данные на случай confirm ON
        localStorage.setItem("pending_profile", JSON.stringify({ login: login, nick: nick, avatar_url: null }));

        var res = await supabase.auth.signUp({
          email: email,
          password: pass,
          options: { data: { login: login, nick: nick } }
        });
        if (res.error){ setMsg(res.error.message); return; }

        // если confirm ON — обычно нет сессии
        var sess = await supabase.auth.getSession();
        var user = sess.data && sess.data.session ? sess.data.session.user : null;

        if (!user){
          setMsg("Аккаунт создан. Подтверди email и затем войди.");
          return;
        }

        var avatarUrl = null;
        if (file){
          try{
            avatarUrl = await uploadAvatar(user.id, file);
          }catch(e){
            console.error(e);
          }
        }

        try{
          await supabase.auth.updateUser({ data: { login: login, nick: nick, avatar_url: avatarUrl } });
        }catch(_){}

        localStorage.setItem("pending_profile", JSON.stringify({ login: login, nick: nick, avatar_url: avatarUrl }));

        var profile = await ensureProfile({ id: user.id, email: user.email, user_metadata: { login: login, nick: nick, avatar_url: avatarUrl } });
        setAuthedUI(user, profile);

      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }finally{
        setBusy(false);
      }
    };

    logoutBtn.onclick = async function(){
      setBusy(true);
      try{
        await supabase.auth.signOut();
        setGuestUI();
      }catch(e){
        console.error(e);
        setMsg(e && e.message ? e.message : String(e));
      }finally{
        setBusy(false);
      }
    };

    // init
    (async function(){
      setMsg("Инициализация...");
      try{
        var sess = await supabase.auth.getSession();
        var user = (sess.data && sess.data.session) ? sess.data.session.user : null;
        if (!user){
          setGuestUI();
          return;
        }
        var profile = await ensureProfile(user);
        setAuthedUI(user, profile);
        setMsg("");
      }catch(e){
        console.error(e);
        setGuestUI();
        setMsg("");
      }
    })();
  })();
  </script>
</body>
</html>
